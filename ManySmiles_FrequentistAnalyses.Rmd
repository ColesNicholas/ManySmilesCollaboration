---
title: 'Frequentist Data Analysis Code for the Many Smiles Collaboration'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans', 'metafor',
                'ggtext')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III Sums of Square
options(contrasts = c('contr.sum', 'contr.poly'))

# set plotting options 
theme_set(theme_classic() +
          theme(strip.background = element_rect(fill = "gray35"),
                strip.text =element_text(colour = "white"),
                panel.border = element_blank(),
                legend.position = "none"
                )
          )
```

## Open data
```{r}
DF.w <- readRDS("data/processed/DF.w.rds")
DF.l.full <- readRDS("data/processed/DF.l.full.rds")
DF.l.full.inc <- readRDS("data/processed/DF.l.full.inc.rds")
DF.l <- readRDS("data/processed/DF.l.rds")
DF.l.inc <- readRDS("data/processed/DF.l.inc.rds")
```

## Participant descriptives
```{r}
# n participants
DF.w %>% nrow()

# n labs
DF.l$lab %>% unique() %>% length()

# n countries
DF.l$lab %>% 
  substr(start = 1,
         stop = 3) %>% 
  unique() %>% 
  length()

# condition n
table(DF.l$condition) %>% prop.table()
table(DF.l$condition, DF.l$image) %>% prop.table()

# descriptives
DF.w %>%
  summarise(n = n(),
            m.age = mean(indiv_agee_var,
                         na.rm = T),
            sd.age = sd(indiv_agee_var,
                        na.rm = T),
            g.women = sum(indiv_gend_var == 1, na.rm = T) / n(),
            g.men = sum(indiv_gend_var == 2, na.rm = T) / n(),
            g.other = sum(indiv_gend_var == 3, na.rm = T) / n(),
            
            # inclusion criteria pass rate
            inc.dev = mean(inc.dev),
            inc.att = mean(inc.att),
            inc.fol = mean(inc.fol),
            inc.mat = mean(inc.mat),
            inc.dis = sum(inc.dis, na.rm = T) / n(),
            inc.awa = sum(inc.awa, na.rm = T) / n()
            )

# n participants who met inclusion criteria
DF.l.inc$ResponseId %>% unique() %>% length()
```

## Analyses
Create list to save models in
```{r}
models <- list()
```

### Primary analyses
#### With application of pre-registered exclusion criteria
##### With random slopes
Fit model and inspect results
```{r}
# fit model
models[["primary"]][["prereg"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg"]])

anova(models[["primary"]][["prereg"]])

joint_tests(models[["primary"]][["prereg"]],
            by = "condition",
            lmerTest.limit = 9999)

# descriptives
emmeans(models[["primary"]][["prereg"]],
        pairwise ~ trial | condition,
        adjust = "none")

```

##### Without random slopes
```{r}
# fit model
models[["primary"]][["prereg.noRS"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.noRS"]])

anova(models[["primary"]][["prereg.noRS"]])

joint_tests(models[["primary"]][["prereg.noRS"]],
            by = "condition",
            lmerTest.limit = 9999)

# descriptives
emmeans(models[["primary"]][["prereg.noRS"]],
        pairwise ~ trial | condition,
        adjust = "none")
```

### Secondary analyses
#### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
##### With random slopes
```{r}
# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial.r * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial.r | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial.r : image | lab) +
         (0 + trial.r : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial.r : condition : image | lab),
       data = tmp.DF)

# inspect results
summary(models[["secondary"]][["alt.exp"]])

anova(models[["secondary"]][["alt.exp"]])

joint_tests(models[["secondary"]][["alt.exp"]], 
            by = "image",
            lmerTest.limit = 9999)

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial.r | condition | image,
        adjust = "none")
```

##### Without random slopes
```{r}
# fit model
models[["secondary"]][["alt.exp.noRS"]] <-
  lmer(happiness ~ trial.r * condition * image +
         (1 | lab) + (1 | ResponseId),
       data = tmp.DF)

# inspect results
summary(models[["secondary"]][["alt.exp.noRS"]])

anova(models[["secondary"]][["alt.exp.noRS"]])

joint_tests(models[["secondary"]][["alt.exp.noRS"]], 
            by = "image",
            lmerTest.limit = 9999)

emmeans(models[["secondary"]][["alt.exp.noRS"]], 
        pairwise ~ trial.r | condition | image,
        adjust = "none")

rm(tmp.DF)
```

#### Group differences in quality indicators
##### Compliance with instructions
###### With random slopes
```{r}
# fit model
models[["secondary"]][["compl.diff"]] <-
  lmer(qulty_rate_var ~ condition + image +
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

# inspect results
emmeans(models[["secondary"]][["compl.diff"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_rate_var),
            sd = sd(qulty_rate_var))
```

###### Without random slopes
```{r}
# without random slopes
models[["secondary"]][["compl.diff.noRS"]] <-
  lmer(qulty_rate_var ~ condition + image +
         (1 | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["compl.diff.noRS"]])

emmeans(models[["secondary"]][["compl.diff.noRS"]], 
        pairwise ~ condition,
        adjust = "none")
```


##### Pose similarity 
###### With random slopes
```{r}
# fit model
models[["secondary"]][["simil.diff"]] <-
  lmer(qulty_smlr_var ~ condition + image +
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["simil.diff"]])

emmeans(models[["secondary"]][["simil.diff"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_smlr_var,
                     na.rm = T),
            sd = sd(qulty_smlr_var,
                    na.rm = T))
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["simil.diff.noRS"]] <-
  lmer(qulty_smlr_var ~ condition + image +
         (1 | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["simil.diff.noRS"]])

emmeans(models[["secondary"]][["simil.diff.noRS"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_smlr_var,
                     na.rm = T),
            sd = sd(qulty_smlr_var,
                    na.rm = T))
```


##### Genuineness ratings
###### With random slopes
```{r}
# fit model
models[["secondary"]][["gen.diff"]] <-
  lmer(qulty_feel_var ~ condition + image +
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

# insprect results
anova(models[["secondary"]][["gen.diff"]])

emmeans(models[["secondary"]][["gen.diff"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_feel_var),
            sd = sd(qulty_feel_var))

DF.w %>% 
  group_by(image) %>% 
  summarise(m = mean(qulty_feel_var),
            sd = sd(qulty_feel_var))
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["gen.diff.noRS"]] <-
  lmer(qulty_feel_var ~ condition + image +
         (1 | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["gen.diff.noRS"]])

emmeans(models[["secondary"]][["gen.diff.noRS"]], 
        pairwise ~ condition,
        adjust = "none")
```

#### Awareness of study hypothesis
##### Group differences
###### With random slopes
```{r}
# fit model
models[["secondary"]][["awareness.diff"]] <-
  lmer(awareness ~ condition + image + 
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["awareness.diff"]])

emmeans(models[["secondary"]][["awareness.diff"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m.awa = mean(awareness,
                         na.rm = T),
            sd.awa = sd(awareness,
                        na.rm = T))
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["awareness.diff.noRS"]] <-
  lmer(awareness ~ condition + image + 
         (1 | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["awareness.diff.noRS"]])

emmeans(models[["secondary"]][["awareness.diff.noRS"]], 
        pairwise ~ condition,
        adjust = "none")
```

##### Moderation by awareness
###### With random slopes
```{r}
# fit model
models[["secondary"]][["awareness.mod"]] <- 
  lmer(happiness ~ 
         trial + condition + image + awareness.c + trial:awareness.c +
         (1 | lab) +
         (1 | ResponseId) +
         (0 + trial | lab) + 
         (0 + condition | lab) + 
         (0 + image | lab) +  
         (0 + trial:awareness.c | lab),
       data = DF.l)

# inspect results
models[["secondary"]][["awareness.mod"]] %>% anova()

models[["secondary"]][["awareness.mod"]] %>% summary()
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["awareness.mod.noRS"]] <- 
  lmer(happiness ~ 
         trial + condition + image + awareness.c + trial:awareness.c +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
models[["secondary"]][["awareness.mod.noRS"]] %>% anova()

models[["secondary"]][["awareness.mod.noRS"]] %>% summary()
```


#### Moderation by body awareness
##### With random slopes
```{r}
# fit model
models[["secondary"]][["body.aware.mod"]] <- 
  lmer(happiness ~ 
         trial * condition * image + indiv_body + trial : indiv_body +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : indiv_body | lab),
       data = DF.l.inc)

# inspect results
models[["secondary"]][["body.aware.mod"]] %>% anova()
models[["secondary"]][["body.aware.mod"]] %>% summary()
```

##### Without random slopes
```{r}
# fit model
models[["secondary"]][["body.aware.mod.noRS"]] <- 
  lmer(happiness ~ 
         trial * condition * image + indiv_body + trial : indiv_body +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
models[["secondary"]][["body.aware.mod.noRS"]] %>% anova()
models[["secondary"]][["body.aware.mod.noRS"]] %>% summary()
```

#### Anxiety 
##### With random slopes
```{r}
# fit model
models[["secondary"]][["anxiety"]] <-
  lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
anova(models[["secondary"]][["anxiety"]])

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ condition,
        adjust = "none")

DF.l.inc %>% 
  group_by(trial) %>% 
  summarise(m = mean(anxiety),
            sd = sd(anxiety))

# no RS
tmp <-  lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
         data = DF.l.inc)

anova(tmp)

emmeans(tmp, 
        pairwise ~ condition,
        adjust = "none")

# no RS or inclusion
lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
         data = DF.l) %>% summary()
```

##### Without random slopes
```{r}
# fit model
models[["secondary"]][["anxiety.noRS"]] <-
  lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
anova(models[["secondary"]][["anxiety.noRS"]])

emmeans(models[["secondary"]][["anxiety.noRS"]], 
        pairwise ~ condition,
        adjust = "none")
```

#### Anger
##### With random slopes
```{r}
# fit model
models[["secondary"]][["anger"]] <-
  lmer(anger ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
anova(models[["secondary"]][["anger"]])

emmeans(models[["secondary"]][["anger"]], 
        pairwise ~ condition,
        adjust = "none")
```


##### Without random slopes
```{r}
# fit model
models[["secondary"]][["anger.noRS"]] <-
  lmer(anger ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
anova(models[["secondary"]][["anger.noRS"]])

emmeans(models[["secondary"]][["anger.noRS"]], 
        pairwise ~ condition,
        adjust = "none")
```


#### Quality Moderator analyses
##### Compliance with instructions
###### With random slopes
```{r}
# fit model
models[["secondary"]][["compl.mod"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_rate_var.c + trial:qulty_rate_var.c +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["quality.rating"]])
confint(models[["secondary"]][["quality.rating"]])
anova(models[["secondary"]][["quality.rating"]])
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["compl.mod.noRS"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_rate_var.c + trial:qulty_rate_var.c +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["compl.mod.noRS"]])
confint(models[["secondary"]][["compl.mod.noRS"]])
anova(models[["secondary"]][["compl.mod.noRS"]])
```

##### Pose similarity
###### With random slopes
```{r}
# fit model
models[["secondary"]][["simil.mod"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_smlr_var.c + trial:qulty_smlr_var.c +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["simil.rating"]])
confint(models[["secondary"]][["simil.rating"]])
anova(models[["secondary"]][["simil.rating"]])
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["simil.mod.noRS"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_smlr_var.c + trial:qulty_smlr_var.c +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["simil.mod.noRS"]])
confint(models[["secondary"]][["simil.mod.noRS"]])
anova(models[["secondary"]][["simil.mod.noRS"]])
```

##### Genuineness ratings
###### With random slopes
```{r}
# fit model
models[["secondary"]][["gen.mod"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_feel_var.c + trial:qulty_feel_var.c +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["gen.mod"]])
anova(models[["secondary"]][["gen.mod"]])
```

###### Without random slopes
```{r}
# fit model
models[["secondary"]][["gen.mod.noRS"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_feel_var.c + trial:qulty_feel_var.c +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["gen.mod.noRS"]])
anova(models[["secondary"]][["gen.mod.noRS"]])
```

### Exploratory Analyses
#### Liking reports
Fit model and inspect results
```{r}
# fit model
models[["exploratory"]][["liking"]] <-
  lmer(tsk ~ trial * condition +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.full.inc)

# inspect results
anova(models[["exploratory"]][["liking"]])

joint_tests(models[["exploratory"]][["liking"]], 
            by = "condition",
            lmerTest.limit = 3008)

emmeans(models[["exploratory"]][["liking"]], 
        pairwise ~ trial | condition,
        adjust = "none")

# descriptives
DF.l.full.inc %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.full.inc %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

#### Relationship between happiness and anxiety
```{r}
# fit model
models[["exploratory"]][["hap.anx"]] <- 
  lmer(happiness ~ trial * image * condition + anxiety +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.l.inc)

# inspect results    
summary(models[["exploratory"]][["hap.anx"]]) 
anova(models[["exploratory"]][["hap.anx"]])
```

#### Primary analyses excluding anxious participants
Filter data, fit model, inspect results
```{r}
# filter data
DF.inc.no.anx <- DF.l.inc %>% 
  filter(anxiety == 1)

# sample size
DF.inc.no.anx$ResponseId %>% unique %>% length()

# fit model
models[["exploratory"]][["no.anx"]] <- 
  lmer(happiness ~ trial * image * condition +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.inc.no.anx)

# inspect results
anova(models[["exploratory"]][["no.anx"]])

joint_tests(models[["exploratory"]][["no.anx"]],
            by = "condition",
            lmerTest.limit = 9999)

# delete vistigial 
rm(DF.inc.no.anx)
```

### Group differences in other inclusion criteria
Prep dataframe
```{r}
DF.w <- DF.w %>% 
  mutate(inc.dev = as.factor(inc.dev),
         inc.att = as.factor(inc.att))

library(car)
```

#### Computer check
##### With random slopes
```{r}
# fit model
models[["secondary"]][["cpu.diff"]] <-
  glmer(inc.dev ~ condition + image +
          (1 | lab) + 
          (0 + condition | lab)  +
          (0 + image | lab),
        data = DF.w,
        family = binomial)

# examine results
Anova(models[["secondary"]][["cpu.diff"]])
```

##### Without random slopes
```{r}
# fit model
models[["secondary"]][["cpu.diff.noRS"]] <-
  glmer(inc.dev ~ condition + image +
          (1 | lab),
        data = DF.w,
        family = binomial)

# examine results
Anova(models[["secondary"]][["cpu.diff.noRS"]])
```

#### Attention check
##### With random slopes
```{r}
# fit model
models[["secondary"]][["att.diff"]] <-
  glmer(inc.att ~ condition + image +
          (1 | lab) + 
          (0 + condition | lab)  +
          (0 + image | lab),
        data = DF.w,
        family = binomial)

# examine results
Anova(tmp)
```

##### Without random slopes
```{r}
# fit model
models[["secondary"]][["att.diff.noRS"]] <-
  glmer(inc.att ~ condition + image +
          (1 | lab),
        data = DF.w,
        family = binomial)

# examine results
Anova(tmp)
```

#### Distraction
##### With random slopes
```{r}
# fit model
models[["secondary"]][["dis.diff"]] <-
  lmer(distraction ~ condition + image + 
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["dis.diff"]])
```

##### Without random slopes
```{r}
# fit model
models[["secondary"]][["dis.diff.noRS"]] <-
  lmer(distraction ~ condition + image + 
         (1 | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["dis.diff.noRS"]])
```

## Save output
```{r}
write_rds(models, "output/analyses/freq.models.Rds")
```
