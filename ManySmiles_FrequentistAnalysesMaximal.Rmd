---
title: 'Data Analysis Code for the Many Smiles Collaboration'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans', 'metafor',
                'ggtext')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III Sums of Square
options(contrasts = c('contr.sum', 'contr.poly'))

# set plotting options 
theme_set(theme_classic() +
          theme(strip.background = element_rect(fill = "gray35"),
                strip.text =element_text(colour = "white"),
                panel.border = element_blank(),
                legend.position = "none"
                )
          )
```

## Open data
```{r}
DF.w <- readRDS("data/processed/DF.w.rds")
DF.l.full <- readRDS("data/processed/DF.l.full.rds")
DF.l.full.inc <- readRDS("data/processed/DF.l.full.inc.rds")
DF.l <- readRDS("data/processed/DF.l.rds")
DF.l.inc <- readRDS("data/processed/DF.l.inc.rds")
```

## Descriptives table
```{r eval = F}
# descriptives for full sample 
desc.1 <- DF.w %>% 
  group_by(country) %>% 
  summarise(t.n = n(),
            t.m.age = mean(indiv_agee_var,
                         na.rm = T),
            t.sd.age = sd(indiv_agee_var,
                        na.rm = T),
            t.women = sum(indiv_gend_var == 1, na.rm = T) / n(),
            t.men = sum(indiv_gend_var == 2, na.rm = T) / n(),
            t.other = sum(indiv_gend_var == 3, na.rm = T) / n(),
            
            # inclusion criteria pass rate
            inc.att = mean(inc.att),
            inc.fol = mean(inc.fol),
            inc.mat = mean(inc.mat),
            inc.dev = mean(inc.dev),
            inc.awa = sum(inc.awa, na.rm = T) / n(),
            inc.dis = sum(inc.dis, na.rm = T) / n()
            )

# descriptives for subset that met inclusion criteria 
desc.2 <- DF.w %>% 
  filter(inc == 1,
         inc.awa == 1) %>% 
  group_by(country) %>% 
  summarise(i.n = n(),
            i.m.age = mean(indiv_agee_var,
                         na.rm = T),
            i.sd.age = sd(indiv_agee_var,
                        na.rm = T),
            i.women = sum(indiv_gend_var == 1, na.rm = T) / n(),
            i.men = sum(indiv_gend_var == 2, na.rm = T) / n(),
            i.other = sum(indiv_gend_var == 3, na.rm = T) / n()
            )

# merge descriptives
desc = full_join(desc.1, desc.2, by = 'country')
rm(desc.1, desc.2)

# clean table
desc <- desc %>% 
  # round values
  mutate_if(is.numeric,
            funs(round(x = .,
                       digits = 2)
                  )
            ) %>% 
  
  # create age text
  mutate(t.m.age = paste0(t.m.age, 
                          " (", t.sd.age, ")"),
         i.m.age = paste0(i.m.age,
                          " (", i.m.age, ")")
         ) %>% 
  
  # create gender text
  mutate(t.women = paste0(t.women, "; ",
                          t.men, "; ",
                          t.other),
         i.women = paste0(i.women, "; ",
                          i.men, "; ",
                          i.other)) %>% 

  # delete vestigial
  select(-c(t.sd.age, t.men, t.other, 
            i.sd.age, i.men, i.other))

# export table
write.csv(desc, "desc.csv")
```


## Participant descriptives
```{r}
# n participants
DF.w %>% nrow()

# n labs
DF.l$lab %>% unique() %>% length()

# n countries
DF.l$lab %>% 
  substr(start = 1,
         stop = 3) %>% 
  unique() %>% 
  length()

# condition n
table(DF.l$condition) %>% prop.table()
table(DF.l$condition, DF.l$image) %>% prop.table()

# descriptives
DF.w %>%
  summarise(n = n(),
            m.age = mean(indiv_agee_var,
                         na.rm = T),
            sd.age = sd(indiv_agee_var,
                        na.rm = T),
            g.women = sum(indiv_gend_var == 1, na.rm = T) / n(),
            g.men = sum(indiv_gend_var == 2, na.rm = T) / n(),
            g.other = sum(indiv_gend_var == 3, na.rm = T) / n(),
            
            # inclusion criteria pass rate
            inc.dev = mean(inc.dev),
            inc.att = mean(inc.att),
            inc.fol = mean(inc.fol),
            inc.mat = mean(inc.mat),
            inc.dis = sum(inc.dis, na.rm = T) / n(),
            inc.awa = sum(inc.awa, na.rm = T) / n()
            )

# n participants who met inclusion criteria
DF.l.inc$ResponseId %>% unique() %>% length()
```

Compliance, similarity, and genuineness descriptives
```{r}
f2.DF <- DF.l.inc %>% 
  # select relevant variables
  dplyr::select(ResponseId, trial, condition, 
         qulty_rate_var, qulty_feel_var, qulty_smlr_var) %>% 
  
  # pivot longer so that there is one row for each moderator
  pivot_longer(cols = c(qulty_rate_var, 
                        qulty_smlr_var,
                        qulty_feel_var),
               names_to = "qual.ind") %>% 
  
  # delete duplicate set of observations in the neutral trial
  filter(trial == "happy") %>% 
  
  # relevel factors 
  mutate(qual.ind = factor(qual.ind,
                           levels = c("qulty_rate_var",
                                      "qulty_feel_var",
                                      "qulty_smlr_var")),
         qual.ind = dplyr::recode(qual.ind,
                           qulty_rate_var = "compliance",
                           qulty_feel_var = "genuineness",
                           qulty_smlr_var = "similarity")
         )
```

Get descriptives
```{r}
# m and sd for each quality indicator for each condition 
desc1 <- f2.DF %>% 
  group_by(condition, qual.ind) %>% 
  summarise(m = round(mean(value,
                           na.rm = T),
                      2),
            sd = round(sd(value, na.rm = T),
                       2))
# n for each quality indicator for each condition
desc2 <- f2.DF %>% 
  filter(!is.na(value)) %>% 
  group_by(condition, qual.ind) %>% 
  tally()
# combine
desc <- full_join(desc1, desc2)
rm(desc1, desc2)
```

Plot
```{r}
ggplot(f2.DF,
       aes(x = value)) +
  
  # split plot by condition and moderator
  facet_grid(cols = vars(condition),
             rows = vars(qual.ind),
             scales = "free_y") +
  
  # plot histogram (as percentage)
  geom_histogram(aes(y = stat(width*density)),
                 bins = 7,
                 fill = "gray60") +
  
  # add bin-specific percentage counts to histogram
  stat_bin(aes(y = stat(width*density),
               label = 
                 paste0((round(stat(width*density),
                               2) * 100),
                        "%")), 
           geom = "text",
           bins = 7,
           size = 2,
           vjust = -.21) +
  
  # paste descriptive statistics to left of histogram
  geom_text(data = desc,
            aes(label = paste0("n = ", n,
                               "\n",
                               "M = ", m,
                               "\n",
                               "SD = ", sd)),
            x = -1.25,
            y = Inf,
            size = 2,
            hjust = 0,
            vjust = 1.25) +
  
  # fix scales
  scale_x_continuous(name = "Self-reported rating",
                     breaks = c(1, 3, 5, 7),
                     expand = expand_scale(mult = c(.30, .01))) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .14)),
                     name = "Percent",
                     labels = scales::percent_format())


rm(f2.DF, desc)
```

## Analyses
Create list to save models in
```{r}
models <- list()
```

### Primary analyses
#### With application of pre-registered exclusion criteria
##### Maximal model
Fit model and inspect results
```{r eval = F}
# fit model
models[["primary"]][["prereg.max"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.max"]])

anova(models[["primary"]][["prereg.max"]])

joint_tests(models[["primary"]][["prereg.max"]],
            by = "condition",
            lmerTest.limit = 9999)

# descriptives
emmeans(models[["primary"]][["prereg.max"]],
        pairwise ~ trial | condition,
        adjust = "none")

```

##### Without random slopes
```{r}
# fit model
models[["primary"]][["prereg.trim"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.trim"]])

anova(models[["primary"]][["prereg.trim"]])

joint_tests(models[["primary"]][["prereg.trim"]],
            by = "condition",
            lmerTest.limit = 9999)

# descriptives
emmeans(models[["primary"]][["prereg.max"]],
        pairwise ~ trial | condition,
        adjust = "none")
```

### Secondary analyses
#### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
Note: this code is all set to not evaluate because it is computationally intensive. It also removes the image absent condition because (a) it helps the model converge in a reasonably quick amount of time and (b) this condition is not relevant for the inferences (see manuscript for more information).  
```{r}
# prepare data
tmp <- DF.l.full.inc %>% 
  filter(trial != "neutr") %>% 
  rowwise() %>% 
  mutate(trial.r = if_else(condition = trial == "happy",
                           true = "happy",
                           false = "filler"),
         trial.r = as.factor(trial.r)) %>% 
  ungroup()
  
# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial.r * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial.r | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial.r : image | lab) +
         (0 + trial.r : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial.r : condition : image | lab),
       data = tmp)

# inspect results
summary(models[["secondary"]][["alt.exp"]])

anova(models[["secondary"]][["alt.exp"]])

joint_tests(models[["secondary"]][["alt.exp"]], 
            by = "image",
            lmerTest.limit = 9999)

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial.r | condition | image,
        adjust = "none")

rm(tmp)
```

Add non-random slope analysis

#### Group differences in quality indicators
##### Compliance with instructions
With subset
```{r}
models[["secondary"]][["compl.diff.sub"]] <-
  lmer(qulty_rate_var ~ condition + image +
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

  
emmeans(models[["secondary"]][["compl.diff.sub"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_rate_var),
            sd = sd(qulty_rate_var))

# without random slopes
noRS <- lmer(qulty_rate_var ~ condition + image +
         (1 | lab),
       data = DF.w)

anova(noRS)

emmeans(noRS, 
        pairwise ~ condition,
        adjust = "none")

rm(noRS)
```


##### Pose similarity 
With random slopes
```{r}
models[["secondary"]][["simil.diff.sub"]] <-
  lmer(qulty_smlr_var ~ condition + image +
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

anova(models[["secondary"]][["simil.diff.sub"]])

emmeans(models[["secondary"]][["simil.diff.sub"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_smlr_var,
                     na.rm = T),
            sd = sd(qulty_smlr_var,
                    na.rm = T))

# without random slopes
noRS <- lmer(qulty_smlr_var ~ condition + image +
         (1 | lab),
       data = DF.w)

anova(noRS)

emmeans(noRS, 
        pairwise ~ condition,
        adjust = "none")

rm(noRS)

```

##### Genuineness ratings
With random slopes
```{r}
models[["secondary"]][["gen.diff.sub"]] <-
  lmer(qulty_feel_var ~ condition + image +
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

anova(models[["secondary"]][["gen.diff.sub"]])

emmeans(models[["secondary"]][["gen.diff.sub"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m = mean(qulty_feel_var),
            sd = sd(qulty_feel_var))

DF.w %>% 
  group_by(image) %>% 
  summarise(m = mean(qulty_feel_var),
            sd = sd(qulty_feel_var))

# without random slopes
noRS <-
  lmer(qulty_feel_var ~ condition + image +
         (1 | lab),
       data = DF.w)

anova(noRS)

emmeans(noRS, 
        pairwise ~ condition,
        adjust = "none")
```

Without random slopes
```{r}
models[["secondary"]][["gen.diff.sub.noRS"]] <-
  lmer(qulty_feel_var ~ condition + image +
         (1 | lab),
       data = DF.l.inc)

anova(models[["secondary"]][["gen.diff.sub.noRS"]])

emmeans(models[["secondary"]][["gen.diff.sub.noRS"]], 
        pairwise ~ condition,
        adjust = "none")
```

#### Effect of facial feedback on anxiety and anger
Anxiety: fit model and inspect results
```{r}
# fit model
models[["secondary"]][["anxiety"]] <-
  lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
anova(models[["secondary"]][["anxiety"]])

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ condition,
        adjust = "none")


DF.l.inc %>% 
  group_by(trial) %>% 
  summarise(m = mean(anxiety),
            sd = sd(anxiety))

# no RS
tmp <-  lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
         data = DF.l.inc)

anova(tmp)

emmeans(tmp, 
        pairwise ~ condition,
        adjust = "none")

# no RS or inclusion
lmer(anxiety ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
         data = DF.l) %>% summary()
```

Anger: fit model and inspect results
```{r}
# fit model
models[["secondary"]][["anger"]] <-
  lmer(anger ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
anova(models[["secondary"]][["anger"]])

emmeans(models[["secondary"]][["anger"]], 
        pairwise ~ condition,
        adjust = "none")

# no RS
tmp <-  lmer(anger ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
         data = DF.l.inc)

anova(tmp)
emmeans(tmp, 
        pairwise ~ condition,
        adjust = "none")

# no RS or exclusion
tmp <-  lmer(anger ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
         data = DF.l)

anova(tmp)
```

Descriptives
```{r}
DF.l %>% 
  group_by(condition) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))

DF.l %>% 
  group_by(trial) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))
```

#### Moderator analyses
##### Quality
###### Compliance with instructions
Full model
```{r}
# fit model
models[["secondary"]][["quality.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_rate_var.c + trial:qulty_rate_var.c +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["quality.rating"]])
confint(models[["secondary"]][["quality.rating"]])
anova(models[["secondary"]][["quality.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
# mimicry
m <- lmer(happiness ~ 
            trial * image * qulty_rate_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "mimicry")

m %>% anova()
m %>% summary()
m %>% confint()

# voluntary facial action task
m <- lmer(happiness ~ 
            trial * image * qulty_rate_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "directd")

m %>% anova()
m %>% summary()
m %>% confint()

# pen-in-mouth
m <- lmer(happiness ~ 
            trial * image * qulty_rate_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "pentask") 

m %>% anova()
m %>% summary()
m %>% confint()

rm(m)
```

Examine how much adherence is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# five is where there is a switch (except for pen, which requires a 6)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_rate_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

###### Pose similarity
```{r}
# fit model
models[["secondary"]][["simil.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_smlr_var.c + trial:qulty_smlr_var.c +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["simil.rating"]])
confint(models[["secondary"]][["simil.rating"]])
anova(models[["secondary"]][["simil.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
# mimicry
m <- lmer(happiness ~ 
            trial * image * qulty_smlr_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "mimicry")

m %>% anova()
m %>% summary()
m %>% confint()

# voluntary facial action task
m <- lmer(happiness ~ 
            trial * image * qulty_smlr_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "directd")

m %>% anova()
m %>% summary()
m %>% confint()

# pen-in-mouth
m <- lmer(happiness ~ 
            trial * image * qulty_smlr_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "pentask")

m %>% anova()
m %>% summary()
m %>% confint()

rm(m)
```

Examine how much similarity is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# 2 is where there is a switch (for all besides mimicry, which requires a 3)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_smlr_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

###### Genuineness ratings
```{r}
# fit model
models[["secondary"]][["feel.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image + qulty_feel_var.c + trial:qulty_feel_var.c +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : image | lab) +
         (0 + trial : condition | lab)  + 
         (0 + condition : image | lab) + 
         (0 + trial : condition : image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["secondary"]][["feel.rating"]])
anova(models[["secondary"]][["feel.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
# facial mimicry
m <- lmer(happiness ~ 
            trial * image * qulty_feel_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "mimicry")

m %>% anova()
m %>% summary()
m %>% confint()

# voluntary facial action task
m <- lmer(happiness ~ 
            trial * image * qulty_feel_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "directd")

m %>% anova()
m %>% summary()
m %>% confint()

# pen-in-mouth
m <- lmer(happiness ~ 
            trial * image * qulty_feel_var.c +
            (1 | lab) + 
            (1 | ResponseId),
          data = DF.l,
          subset = condition == "pentask")

m %>% anova()
m %>% summary()
m %>% confint()

rm(m)
```

Examine how much genuineness is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# 2 is when it switches over (for all conditions)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_feel_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

#### other inclusion criteria
computer check
```{r}
DF.w <- DF.w %>% 
  mutate(inc.dev = as.factor(inc.dev))

tmp <- glmer(inc.dev ~ condition + image +
        (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
      data = DF.w,
      family = binomial)


library(car)
Anova(tmp)

# without random slopes
tmp <- glmer(inc.dev ~ condition + image +
        (1 | lab),
      data = DF.w,
      family = binomial)

Anova(tmp)

rm(tmp)
```

attention check
```{r}
DF.w <- DF.w %>% 
  mutate(inc.att = as.factor(inc.att))

tmp <- glmer(inc.att ~ condition + image +
        (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
      data = DF.w,
      family = binomial)

Anova(tmp)

# without random slopes
tmp <- glmer(inc.att ~ condition + image +
        (1 | lab),
      data = DF.w,
      family = binomial)

Anova(tmp)

rm(tmp)
```

Distraction
```{r}
tmp <- lmer(distraction ~ condition + image + 
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

anova(tmp)

tmp <- lmer(distraction ~ condition + image + 
         (1 | lab),
       data = DF.w)

anova(tmp)
```


##### Awareness
Test whether certain facial feedback tasks lead to higher levels of awareness than others
```{r}
# fit model
models[["secondary"]][["awareness.diff"]] <-
  lmer(awareness ~ condition + image + 
         (1 | lab) + 
         (0 + condition | lab)  +
         (0 + image | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["awareness.diff"]])

emmeans(models[["secondary"]][["awareness.diff"]], 
        pairwise ~ condition,
        adjust = "none")

DF.w %>% 
  group_by(condition) %>% 
  summarise(m.awa = mean(awareness,
                         na.rm = T),
            sd.awa = sd(awareness,
                        na.rm = T))

no.RS <- lmer(awareness ~ condition + image + 
         (1 | lab),
       data = DF.w)
anova(no.RS)
emmeans(no.RS, 
        pairwise ~ condition,
        adjust = "none")

rm(no.RS)
```

Test whether awareness moderates facial feedback effects
```{r}
# fit model
models[["secondary"]][["awareness"]] <- 
  lmer(happiness ~ 
         trial + condition + image + awareness.c + trial:awareness.c +
         (1 | lab) +
         (1 | ResponseId) +
         (0 + trial | lab) + 
         (0 + condition | lab) + 
         (0 + image | lab) +  
         (0 + trial:awareness.c | lab),
       data = DF.l)

models[["secondary"]][["awareness"]] %>% anova()

models[["secondary"]][["awareness"]] %>% summary()

models[["secondary"]][["awareness"]] %>% confint()

lmer(happiness ~ 
       trial + condition + image + awareness.c + trial:awareness.c +
       (1 | lab) +
       (1 | ResponseId),
     data = DF.l) %>% summary()

```

##### Body awareness
```{r}
# fit model
models[["secondary"]][["body.aware"]] <- 
  lmer(happiness ~ 
         trial * condition * image + indiv_body + trial : indiv_body +
         (1 | lab) + (1 | ResponseId) + 
         (0 + trial | lab) +
         (0 + condition | lab)  +
         (0 + image | lab) +
         (0 + trial : indiv_body | lab),
       data = DF.l.inc)

# inspect results
models[["secondary"]][["body.aware"]] %>% anova()
models[["secondary"]][["body.aware"]] %>% summary()

# wRS
tmp <- lmer(happiness ~ 
         trial * condition * image + indiv_body + trial : indiv_body +
         (1 | lab) + (1 | ResponseId),
       data = DF.l.inc)

```

### Exploratory Analyses
#### Liking reports
Fit model and inspect results
```{r}
# fit model
models[["exploratory"]][["liking"]] <-
  lmer(tsk ~ trial * condition +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.full.inc)

# inspect results
anova(models[["exploratory"]][["liking"]])

joint_tests(models[["exploratory"]][["liking"]], 
            by = "condition",
            lmerTest.limit = 3008)

emmeans(models[["exploratory"]][["liking"]], 
        pairwise ~ trial | condition,
        adjust = "none")

# descriptives
DF.l.full.inc %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.full.inc %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

#### Model with anxiety
```{r}
m <- 
  lmer(happiness ~ trial * image * condition + anxiety +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.l.inc)
    
summary(m) 
confint(m)
anova(m)

joint_tests(m,
            by = "condition",
            lmerTest.limit = 9999)
```

#### Primary analyses excluding anxious participants
Filter data, fit model, inspect results
```{r}
# filter data
DF.inc.no.anx <- DF.l.inc %>% 
  filter(anxiety == 1)

# sample size
DF.inc.no.anx$ResponseId %>% unique %>% length()

# fit model
models[["exploratory"]][["no.anx"]] <- 
  lmer(happiness ~ trial * image * condition +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.inc.no.anx)

# inspect results
anova(models[["exploratory"]][["no.anx"]])

joint_tests(models[["exploratory"]][["no.anx"]],
            by = "condition",
            lmerTest.limit = 9999)

# delete vistigial 
rm(DF.inc.no.anx)
```

#### J-N analyses
Compliance
```{r}
library('interactions')

tmp <- DF.l %>% 
  mutate(trial.n = as.numeric(trial) - 1)

m <- lmer(happiness ~ trial.n * qulty_rate_var +
            (1 | ResponseId) +
            (1 | lab),
          data = tmp)

summary(m)

johnson_neyman(model = m, 
               pred = trial.n, 
               modx = qulty_rate_var)
```

Similarity
```{r}
m <- lmer(happiness ~ trial.n * qulty_smlr_var +
            (1 | ResponseId) +
            (1 | lab),
          data = tmp)

summary(m)

johnson_neyman(model = m, 
               pred = trial.n, 
               modx = qulty_smlr_var)
```

Genuineness
```{r}
m <- lmer(happiness ~ trial.n * qulty_feel_var +
            (1 | ResponseId) +
            (1 | lab),
          data = tmp)

summary(m)

johnson_neyman(model = m, 
               pred = trial.n, 
               modx = qulty_feel_var)
```

```{r}
# add sig cutoffs
f2.DF <- as.data.frame(f2.DF)
f2.DF$sig.cross <- NA
f2.DF[f2.DF$qual.ind == "compliance", ]$sig.cross <- 4.17
f2.DF[f2.DF$qual.ind == "similarity", ]$sig.cross <- 1.73
f2.DF[f2.DF$qual.ind == "genuineness", ]$sig.cross <- 1.69
```


```{r}
ggplot(f2.DF,
       aes(x = value)) +
  
  # split plot by condition and moderator
  facet_grid(cols = vars(condition),
             rows = vars(qual.ind),
             scales = "free_y") +
  
  # plot histogram (as percentage)
  geom_histogram(aes(y = stat(width*density)),
                 bins = 7,
                 fill = "gray60") +
  
  #
  geom_rect(aes(xmin = sig.cross,
                xmax = 7,
                ymin = 0,
              ymax = .8 
                ),
            fill = "lightgreen",
            alpha = .01) +
  scale_x_continuous(
    breaks = c(1, 3, 5, 7))
```

```{r}
tmp <- DF.l.inc %>% 
  filter(qulty_feel_var > 5)


m <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) + (1 | ResponseId),
       data = tmp)

# inspect results
summary(m)

anova(m)

joint_tests(m,
            by = "condition",
            lmerTest.limit = 9999)

```

