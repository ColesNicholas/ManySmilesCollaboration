---
title: 'Data Analysis Code for the Many Smiles Collaboration'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans', 'metafor',
                'ggtext')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III Sums of Square
options(contrasts = c('contr.sum', 'contr.poly'))

# set plotting options 
theme_set(theme_classic() +
          theme(strip.background = element_rect(fill = "gray35"),
                strip.text =element_text(colour = "white"),
                panel.border = element_blank(),
                legend.position = "none"
                )
          )
```

## Open data
```{r}
DF.w <- readRDS("data/DF.w.rds")
DF.l.full <- readRDS("data/DF.l.full.rds")
DF.l <- readRDS("data/DF.l.rds")
DF.l.inc <- readRDS("data/DF.l.inc.rds")
```

## Descriptives table
```{r}
desc.1 <- DF.w %>% 
  group_by(country) %>% 
  summarise(n = n(),
            inc.att = mean(inc.att),
            inc.fol = mean(inc.fol),
            inc.mat = mean(inc.mat),
            inc.dev = mean(inc.dev),
            inc.awa = sum(inc.awa, na.rm = T) / n(),
            inc.dis = sum(inc.dis, na.rm = T) / n())

desc.2 <- DF.w %>% 
  filter(inc == 1,
         inc.awa == 1) %>% 
  group_by(country) %>% 
  summarise(n = n())

desc = full_join(desc.1, desc.2, by = 'country')
#
            n.inc = nrow(.[!is.na(.$inc) & 
                          !is.na(.$inc.awa) &
                          .$inc == 1 &
                          .$inc.awa == 1, ]))
            ) %>% View()

inc.att, inc.fol, inc.mat, inc.dev, inc.awa, inc.dis, inc

```


## Participant descriptives
```{r}
# n participants
DF.w %>% nrow()

# n labs
DF.l$lab %>% unique() %>% length()

# n countries
DF.l$lab %>% 
  substr(start = 1,
         stop = 3) %>% 
  unique() %>% 
  length()

# condition n
table(DF.l$condition) %>% prop.table()
table(DF.l$condition, DF.l$image) %>% prop.table()

# gender
table(DF.l$indiv_gend_var) %>% prop.table()

# age
DF.w %>% 
  summarise(m = mean(indiv_agee_var,
                     na.rm = T),
            sd = sd(indiv_agee_var,
                    na.rm = T))
```

## Analyses
Create list to save models in
```{r}
models <- list()
```

### Primary analyses
#### With application of pre-registered exclusion criteria
Fit model and inspect results
```{r}
# fit model 
models[["primary"]][["prereg.min"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.min"]])

anova(models[["primary"]][["prereg.min"]])

joint_tests(models[["primary"]][["prereg.min"]],
            by = "condition",
            lmerTest.limit = 9999)

joint_tests(models[["primary"]][["prereg.min"]], 
            by = c("image", "condition"),
            lmerTest.limit = 9999)

# descriptives
DF.l.inc %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.inc %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

Simple comparison of facial mimicry and voluntary facial action task
```{r}
lmer(happiness ~ trial * condition * image +
       (1 | ResponseId) +
       (1 | lab),
     data = DF.l.inc,
     subset = condition != "pentask") %>% 
  anova()
```

#### Sensitivity analysis with maximal model
Note: this code is all set to not evaluate because it is computationally intensive

Fit model and inspect results
```{r eval = F}
# fit model
models[["primary"]][["prereg.max"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | ResponseId) +
         (1 + trial * condition * image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.max"]])

anova(models[["primary"]][["prereg.max"]])

joint_tests(models[["primary"]][["prereg.max"]],
            by = "condition",
            lmerTest.limit = 9999)

joint_tests(models[["primary"]][["prereg.max"]], 
            by = c("image", "condition"),
            lmerTest.limit = 9999)
```

#### Sensitivity analysis with full dataset
Fit model and inspect results
```{r}
# fit model
models[["primary"]][["full.sens"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.l)

# inspect results
summary(models[["primary"]][["full.sens"]])

anova(models[["primary"]][["full.sens"]])

joint_tests(models[["primary"]][["full.sens"]], 
            by = "condition",
            lmerTest.limit = c)

joint_tests(models[["primary"]][["full.sens"]],
            by = "condition",
            lmerTest.limit = full.sens)

joint_tests(models[["primary"]][["full.sens"]], 
            by = c("image", "condition"),
            lmerTest.limit = full.sens)
```

### Secondary analyses
#### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
Prepare data by choosing the full dataset (which contains filler trials) and applying inclusion criteria.
```{r}
DF.l.fil <- DF.l.full %>% 
  filter(inc == 1,
         inc.awa == 1)
```

Fit model and inspect results
```{r}
# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

# inspect results
anova(models[["secondary"]][["alt.exp"]])

joint_tests(models[["secondary"]][["alt.exp"]], 
            by = "image",
            lmerTest.limit = 9999)

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial | condition | image,
        adjust = "none")
```

##### Sensitivity analysis with maximial model
Note: this code is all set to not evaluate because it is computationally intensive. It also removes the image absent condition because (a) it helps the model converge in a reasonably quick amount of time and (b) this condition is not relevant for the inferences (see manuscript for more information).  
```{r eval = F}
# prepare data
DF.l.fil <- DF.l.full %>% 
  filter(inc == 1,
         inc.awa == 1,
         image == "absentt")

# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial * condition +
         (1 + trial * condition | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

# inspect results
anova(models[["secondary"]][["alt.exp"]])

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial | condition,
        adjust = "none")
```

#### Effect of facial feedback on anxiety and anger
Anxiety: fit model and inspect results
```{r}
# fit model
models[["secondary"]][["anxiety"]] <-
  lmer(anxiety ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["anxiety"]])
```

Anger: fit model and inspect results
```{r}
# fit model
models[["secondary"]][["anger"]] <-
  lmer(anger ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["anger"]])
```

Descriptives
```{r}
DF.l %>% 
  group_by(condition) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))

DF.l %>% 
  group_by(trial) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))
```

#### Moderator analyses
##### Quality
###### Compliance with instructions
```{r}
# fit model
models[["secondary"]][["quality.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["quality.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
lmer(happiness ~ 
         trial * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()
```

Examine how much adherence is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# five is where there is a switch (except for pen, which requires a 6)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_rate_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

###### Pose similarity
```{r}
# fit model
models[["secondary"]][["simil.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["simil.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
lmer(happiness ~ 
         trial * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()
```

Examine how much similarity is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# 2 is where there is a switch (for all besides mimicry, which requires a 3)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_smlr_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

###### Genuineness ratings
```{r}
# fit model
models[["secondary"]][["feel.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["feel.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
lmer(happiness ~ 
         trial * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()
```

Examine how much genuineness is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# 2 is when it switches over (for all conditions)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_feel_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

##### Awareness
Test whether awareness moderates facial feedback effects
```{r}
# fit model
models[["secondary"]][["awareness"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  awareness +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["awareness"]])
```

Test whether certain facial feedback tasks lead to higher levels of awareness than others
```{r}
# fit model
models[["secondary"]][["awareness.diff"]] <-
  lmer(awareness ~ condition + image + 
         (1 | lab),
       data = DF.w)

# inspect results
anova(models[["secondary"]][["awareness.diff"]])

emmeans(models[["secondary"]][["awareness.diff"]], 
        pairwise ~ condition,
        adjust = "none")
```


##### Body awareness
```{r}
# fit model
models[["secondary"]][["body.aware"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  indiv_body +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["body.aware"]])
```

### Exploratory Analyses
#### Liking reports
Fit model and inspect results
```{r}
# fit model
models[["exploratory"]][["liking"]] <-
  lmer(tsk ~ trial * condition +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

# inspect results
anova(models[["exploratory"]][["liking"]])

joint_tests(models[["exploratory"]][["liking"]], 
            by = "condition",
            lmerTest.limit = 3008)

emmeans(models[["exploratory"]][["liking"]], 
        pairwise ~ trial | condition,
        adjust = "none")

# descriptives
DF.l.fil %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.fil %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

#### Primary analyses excluding anxious participants
Filter data, fit model, inspect results
```{r}
# filter data
DF.inc.no.anx <- DF.l.inc %>% 
  filter(anxiety == 1)

# sample size
DF.inc.no.anx$ResponseId %>% unique %>% length()

# fit model
models[["exploratory"]][["no.anx"]] <- 
  lmer(happiness ~ trial * image * condition +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.inc.no.anx)

# inspect results
anova(models[["exploratory"]][["no.anx"]])

joint_tests(models[["exploratory"]][["no.anx"]],
            by = "condition",
            lmerTest.limit = 9999)

# delete vistigial 
rm(DF.inc.no.anx)
```
