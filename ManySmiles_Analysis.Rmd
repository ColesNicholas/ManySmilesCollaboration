---
title: 'Data Analysis Code for the Many Smiles Collaboration'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III Sums of Square
options(contrasts = c('contr.sum', 'contr.poly'))

# set plotting options 
theme_set(theme_classic() +
          theme(strip.background = 
                  element_rect(fill = "gray35"),
                strip.text = 
                  element_text(colour = "white"),
                panel.border = element_blank()
                )
          )
```

## Open data
```{r}
DF.l.full <- readRDS("data/DF.l.full.rds")
DF.l <- readRDS("data/DF.l.rds")
DF.l.inc <- readRDS("data/DF.l.inc.rds")
```

## Participant descriptives
```{r}
# n participants
DF.l$ResponseId %>% unique() %>% length()

# n labs
DF.l$lab %>% unique() %>% length()

# n countries
DF.l$lab %>% 
  substr(start = 1,
         stop = 3) %>% 
  unique() %>% 
  length()

# condition n
table(DF.l$condition) %>% prop.table()
table(DF.l$condition, DF.l$image) %>% prop.table()

# gender
table(DF.l$indiv_gend_var) %>% prop.table()

# age
DF.l %>% 
  summarise(m = mean(indiv_agee_var,
                     na.rm = T),
            sd = sd(indiv_agee_var,
                    na.rm = T))
```

## Analyses
Create list to save models in
```{r}
models <- list()
```

### Primary analyses
#### With full dataset
```{r}
models[["primary"]][["full"]] <-
  lmer(happiness ~ trial * condition * image + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["primary"]][["full"]])

joint_tests(models[["primary"]][["full"]], 
            by = "condition",
            lmerTest.limit = 10000)

emmeans(models[["primary"]][["full"]], 
        pairwise ~ trial | image | condition,
        adjust = "none")
```

#### With application of pre-registered exclusion criteria
```{r}
models[["primary"]][["partial"]] <-
  lmer(happiness ~ trial * condition * image + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.inc)
```

```{r}
anova(models[["primary"]][["partial"]])

joint_tests(models[["primary"]][["partial"]], 
            by = "condition",
            lmerTest.limit = 3008)

joint_tests(models[["primary"]][["partial"]], 
            by = c("image", "condition"),
            lmerTest.limit = 3008)

joint_tests(models[["primary"]][["partial"]], 
            by = "image",
            lmerTest.limit = 3008)

emmeans(models[["primary"]][["partial"]], 
        pairwise ~ trial | image | condition,
        adjust = "none")

DF.l.inc %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.inc %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

### Secondary analyses
#### Liking reports
```{r}
# prepare data
DF.l.fil <- DF.l.full %>% 
  filter(inc == 1,
         inc.awa == 1)

# fit model
models[["secondary"]][["liking"]] <-
  lmer(tsk ~ trial * condition +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)
```

```{r}
anova(models[["secondary"]][["liking"]])

joint_tests(models[["secondary"]][["liking"]], 
            by = "condition",
            lmerTest.limit = 3008)

emmeans(models[["secondary"]][["liking"]], 
        pairwise ~ trial | condition,
        adjust = "none")

DF.l.fil %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.fil %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

#### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
```{r}
# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial * condition * image+
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)
```

```{r}
anova(models[["secondary"]][["alt.exp"]])

joint_tests(models[["secondary"]][["alt.exp"]], 
            by = "image",
            lmerTest.limit = 6016)

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial | condition | image,
        adjust = "none")

rm(DF.l.fil)
```

#### Effect of facial feedback on anxiety
```{r}
models[["secondary"]][["anxiety"]] <-
  lmer(anxiety ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["secondary"]][["anxiety"]])

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ trial ,
        adjust = "none")

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ condition,
        adjust = "none")

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ trial | condition,
        adjust = "none")
```

#### Effect of facial feedback on anger
```{r}
models[["secondary"]][["anger"]] <-
  lmer(anger ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["secondary"]][["anger"]])

emmeans(models[["secondary"]][["anger"]], 
        pairwise ~ trial ,
        adjust = "none")

emmeans(models[["secondary"]][["anger"]], 
        pairwise ~ condition,
        adjust = "none")

DF.l %>% 
  group_by(trial) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))
```

### Supplemental Analyses
#### Condition-based differences in inclusion criteria and moderators
##### Quality
###### Pose quality
```{r}
models[["supplementary"]][["cond.diff"]][["quality.rating"]] <-
  lmer(qulty_rate_var ~ condition * image +
         (1 | lab),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["quality.rating"]])

emmeans(models[["supplementary"]][["cond.diff"]][["quality.rating"]], 
        pairwise ~ condition | image,
        adjust = "none")
```

###### Pose similarity
```{r}
models[["supplementary"]][["cond.diff"]][["simil.rating"]] <-
  lmer(qulty_smlr_var ~ condition * image +
         (1 | lab),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["simil.rating"]])

emmeans(models[["supplementary"]][["cond.diff"]][["simil.rating"]], 
        pairwise ~ condition,
        adjust = "none")
```

###### Pose feeling
```{r}
models[["supplementary"]][["cond.diff"]][["feel.rating"]] <-
  lmer(qulty_feel_var ~ condition * image +
         (1 | lab),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["feel.rating"]])

emmeans(models[["supplementary"]][["cond.diff"]][["feel.rating"]], 
        pairwise ~ condition | image,
        adjust = "none")
```

##### Other
Awareness
```{r}
models[["supplementary"]][["cond.diff"]][["awareness"]] <-
  lmer(awareness ~ condition * image +
         (1 | lab),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["awareness"]])

emmeans(models[["supplementary"]][["cond.diff"]][["awareness"]], 
        pairwise ~ condition | image,
        adjust = "none")
```

#### Moderators
##### Quality
###### Pose quality
Fit model
```{r}
models[["supplementary"]][["quality.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["quality.rating"]])

lmer(happiness ~ 
         trial * image * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()

# decompose trial * quality * condition interaction
## examine when quality is one SD below mean
# decomp.low = mean(DF.l$qulty_rate_var,
#                   na.rm = T) -
#   sd(DF.l$qulty_rate_var,
#      na.rm = T)
decomp.low = min(DF.l$qulty_rate_var,
                 na.rm = T)
  
emmeans(models[["supplementary"]][["quality.rating"]],
        pairwise ~ trial | condition | qulty_rate_var,
        at = list(qulty_rate_var = decomp.low))

## when quality is one SD above mean
# decomp.high = mean(DF.l$qulty_rate_var,
#                   na.rm = T) +
#   sd(DF.l$qulty_rate_var,
#      na.rm = T)
decomp.high = max(DF.l$qulty_rate_var,
                  na.rm = T)
emmeans(models[["supplementary"]][["quality.rating"]],
        pairwise ~ trial | condition | qulty_rate_var,
        at = list(qulty_rate_var = decomp.high))

rm(decomp.high, decomp.low)
```

###### Pose similarity
```{r}
models[["supplementary"]][["simil.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["simil.rating"]])

lmer(happiness ~ 
         trial * image * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()

# decompose trial * quality * condition interaction
## examine when quality is one SD below mean
decomp.low = mean(DF.l$qulty_smlr_var,
                  na.rm = T) -
  sd(DF.l$qulty_smlr_var,
     na.rm = T)
  
emmeans(models[["supplementary"]][["simil.rating"]],
        pairwise ~ trial | condition | qulty_smlr_var,
        at = list(qulty_smlr_var = decomp.low))

## when quality is one SD above mean
decomp.high = mean(DF.l$qulty_smlr_var,
                   na.rm = T) +
  sd(DF.l$qulty_smlr_var,
     na.rm = T)

emmeans(models[["supplementary"]][["simil.rating"]],
        pairwise ~ trial | condition | qulty_smlr_var,
        at = list(qulty_smlr_var = decomp.high))

rm(decomp.high, decomp.low)
```

###### Pose feeling
```{r}
models[["supplementary"]][["feel.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["feel.rating"]])

lmer(happiness ~ 
         trial * image * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()

# decompose trial * quality * condition interaction
## examine when quality is one SD below mean
decomp.low = mean(DF.l$qulty_feel_var,
                  na.rm = T) -
  sd(DF.l$qulty_feel_var,
     na.rm = T)
  
emmeans(models[["supplementary"]][["feel.rating"]],
        pairwise ~ trial | condition | qulty_feel_var,
        at = list(qulty_feel_var = decomp.low))

## when quality is one SD above mean
decomp.high = mean(DF.l$qulty_feel_var,
                  na.rm = T) +
  sd(DF.l$qulty_feel_var,
     na.rm = T)

emmeans(models[["supplementary"]][["feel.rating"]],
        pairwise ~ trial | condition | qulty_feel_var,
        at = list(qulty_feel_var = decomp.high))

rm(decomp.high, decomp.low)
```

##### Awareness
```{r}
models[["supplementary"]][["awareness"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  awareness +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["awareness"]])

# decompose trial * awareness  interaction
## examine when awareness is one SD below mean
decomp.low = mean(DF.l$awareness,
                  na.rm = T) -
  sd(DF.l$awareness,
     na.rm = T)
  
emmeans(models[["supplementary"]][["awareness"]],
        pairwise ~ trial | awareness,
        at = list(awareness = decomp.low))

## when awareness is one SD above mean
decomp.high = mean(DF.l$awareness,
                   na.rm = T) -
  sd(DF.l$awareness,
     na.rm = T)

emmeans(models[["supplementary"]][["awareness"]],
        pairwise ~ trial | awareness,
        at = list(qulty_rate_var = decomp.high))

rm(decomp.high, decomp.low)
```

##### Body awareness
indiv_body
```{r}
models[["supplementary"]][["body.aware"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  indiv_body +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["body.aware"]])

# decompose trial * awareness  interaction
## examine when awareness is one SD below mean
decomp.low = mean(DF.l$indiv_body,
                  na.rm = T) -
  sd(DF.l$indiv_body,
     na.rm = T)
  
emmeans(models[["supplementary"]][["body.aware"]],
        pairwise ~ trial | indiv_body,
        at = list(awareness = decomp.low))

## when awareness is one SD above mean
decomp.high = mean(DF.l$indiv_body,
                   na.rm = T) -
  sd(DF.l$indiv_body,
     na.rm = T)

emmeans(models[["supplementary"]][["body.aware"]],
        pairwise ~ trial | indiv_body,
        at = list(qulty_rate_var = decomp.high))

rm(decomp.high, decomp.low)
```

## Data viz
### Figure 1
Fix labels
```{r}
DF.viz <- 
  DF.l.full %>%
  filter(inc == 1,
         inc.awa == 1) %>% 
  mutate(trial = factor(trial,
                        levels = c("happy",
                                   "neutr",
                                   "fil.1",
                                   "fil.4")),
         trial = recode(trial,
                        fil.1 = "filler 1",
                        happy = "happy",
                        neutr = "neutral",
                        fil.4 = "filler 2"),
         condition = factor(condition,
                            levels = c("mimicry",
                                       "directd",
                                       "pentask")),
         condition = recode(condition,
                            directd = "voluntary facial action",
                            mimicry = "facial mimicry",
                            pentask = "pen-in-mouth"),
         image = recode(image,
                        absentt = "positive stimuli absent",
                        present = "positive stimuli present")
         )
```

```{r}
png(filename = "Figurec.png", 
       units = "in", 
       width = 9, 
       height = 5.07, 
       res = 300)

ggplot(DF.viz, 
       aes(x = trial, 
           y = happiness)) +
  facet_grid(rows = vars(image),
             cols = vars(condition)) +
  geom_jitter(width = .1, 
              alpha = .035) + 
  geom_line(alpha = .035, 
            aes(group = ResponseId)) +
  stat_summary(geom = "line",
               colour = "black",
               size = 1,
               aes(group = 1)) +
  stat_summary(colour = "black", 
               size = .5,
               fun = "mean") +
  labs(y = "Self-reported happiness", 
       x = "Task")

dev.off()
```

```{r}
# end of code
```

