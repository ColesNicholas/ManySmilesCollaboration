---
title: 'Many Smiles Collaboration Data Analysis'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III SS
options(contrasts = c('contr.sum', 'contr.poly'))
```

## Open data
```{r}
DF.l <- readRDS("data/DF.l.rds")
DF.l.full <- readRDS("data/DF.l.full.rds")
```

## Participant descriptives
```{r}
# condition n
table(DF.l$condition) %>% prop.table()

table(DF.l$condition, DF.l$image) %>% prop.table()

# gender
table(DF.l$indiv_gend_var) %>% prop.table()

# age
DF.l %>% 
  summarise(m = mean(indiv_agee_var,
                     na.rm = T),
            sd = sd(indiv_agee_var,
                    na.rm = T))

# lab
table(DF.l$lab)
```

## Analyses
Create list to save models in
```{r}
models <- list()
```

### Primary analyses
#### With full dataset
```{r}
models[["primary"]][["full"]] <-
  lmer(happiness ~ trial * condition * image + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["primary"]][["full"]])

joint_tests(models[["primary"]][["full"]], 
            by = "condition")

emmeans(models[["primary"]][["full"]], 
        pairwise ~ trial | image | condition,
        adjust = "none")
```

#### With partial dataset
```{r}
# remove participants who exhibited awareness of the hypothesis
DF.l.unaware <- DF.l %>% 
  filter(inc.awa == 1)
```

```{r}
models[["primary"]][["partial"]] <-
  lmer(happiness ~ trial * condition * image + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.unaware)
```

```{r}
anova(models[["primary"]][["partial"]])

joint_tests(models[["primary"]][["partial"]], 
            by = "condition")

emmeans(models[["primary"]][["partial"]], 
        pairwise ~ trial | image | condition,
        adjust = "none")

rm(DF.l.unaware)
```

### Secondary analyses
#### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
```{r}
# prepare data
DF.l.fil <- DF.l.full %>% 
  filter(trial != "neutr") %>% 
  mutate(
    trial.fvh = ifelse(test = trial == "happy",
                       yes = "happy",
                       no = "filler"),
    trial.fvh = factor(trial.fvh)
    )

# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial.fvh * condition * image +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

rm(DF.l.fil)
```

```{r}
anova(models[["secondary"]][["alt.exp"]])

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial.fvh | image | condition,
        adjust = "none")
```

#### Effect of facial feedback on anxiety
```{r}
models[["secondary"]][["anxiety"]] <-
  lmer(anxiety ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["secondary"]][["anxiety"]])

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ trial ,
        adjust = "none")

emmeans(models[["secondary"]][["anxiety"]], 
        pairwise ~ condition,
        adjust = "none")
```


#### Effect of facial feedback on anger
```{r}
models[["secondary"]][["anger"]] <-
  lmer(anger ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["secondary"]][["anger"]])

emmeans(models[["secondary"]][["anger"]], 
        pairwise ~ trial ,
        adjust = "none")

emmeans(models[["secondary"]][["anger"]], 
        pairwise ~ condition,
        adjust = "none")
```

### Supplemental Analyses
Using full dataset (that does not exclude participants based on pose quality ratings), isolate the critical trials
```{r}
DF.l.pose <- DF.l.full %>% 
  filter(trial != 'fil.1',
         trial != 'fil.4') %>% 
  mutate(trial = factor(trial))
```

#### Condition-based differences in inclusion criteria and moderators
##### Quality
###### Pose quality
```{r}
models[["supplementary"]][["cond.diff"]][["quality.rating"]] <-
  lmer(qulty_rate_var ~ condition * image +
         (1 | lab),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["quality.rating"]])

emmeans(models[["supplementary"]][["cond.diff"]][["quality.rating"]], 
        pairwise ~ condition | image,
        adjust = "none")
```

###### Pose similarity
```{r}
models[["supplementary"]][["cond.diff"]][["simil.rating"]] <-
  lmer(qulty_smlr_var ~ condition * image +
         (1 | lab),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["simil.rating"]])

emmeans(models[["supplementary"]][["cond.diff"]][["simil.rating"]], 
        pairwise ~ condition,
        adjust = "none")
```

###### Pose feeling
```{r}
models[["supplementary"]][["cond.diff"]][["feel.rating"]] <-
  lmer(qulty_feel_var ~ condition * image +
         (1 | lab),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["feel.rating"]])

emmeans(models[["supplementary"]][["cond.diff"]][["feel.rating"]], 
        pairwise ~ condition | image,
        adjust = "none")
```

##### Other
Awareness
```{r}
models[["supplementary"]][["cond.diff"]][["awareness"]] <-
  lmer(awareness ~ condition * image +
         (1 | lab),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["cond.diff"]][["awareness"]])

emmeans(models[["supplementary"]][["cond.diff"]][["awareness"]], 
        pairwise ~ condition | image,
        adjust = "none")
```

#### Moderators
##### Quality
###### Pose quality
Fit model
```{r}
models[["supplementary"]][["quality.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["quality.rating"]])

# decompose trial * quality * condition interaction
## examine when quality is one SD below mean
decomp.low = mean(DF.l.pose$qulty_rate_var,
                  na.rm = T) -
  sd(DF.l.pose$qulty_rate_var,
     na.rm = T)
  
emmeans(models[["supplementary"]][["quality.rating"]],
        pairwise ~ trial | condition | qulty_rate_var,
        at = list(qulty_rate_var = decomp.low))

## when quality is one SD above mean
decomp.high = mean(DF.l.pose$qulty_rate_var,
                  na.rm = T) +
  sd(DF.l.pose$qulty_rate_var,
     na.rm = T)

emmeans(models[["supplementary"]][["quality.rating"]],
        pairwise ~ trial | condition | qulty_rate_var,
        at = list(qulty_rate_var = decomp.high))

rm(decomp.high, decomp.low)
```

###### Pose similarity
```{r}
models[["supplementary"]][["simil.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["simil.rating"]])

# decompose trial * quality * condition interaction
## examine when quality is one SD below mean
decomp.low = mean(DF.l.pose$qulty_smlr_var,
                  na.rm = T) -
  sd(DF.l.pose$qulty_smlr_var,
     na.rm = T)
  
emmeans(models[["supplementary"]][["simil.rating"]],
        pairwise ~ trial | condition | qulty_smlr_var,
        at = list(qulty_smlr_var = decomp.low))

## when quality is one SD above mean
decomp.high = mean(DF.l.pose$qulty_smlr_var,
                  na.rm = T) +
  sd(DF.l.pose$qulty_smlr_var,
     na.rm = T)

emmeans(models[["supplementary"]][["simil.rating"]],
        pairwise ~ trial | condition | qulty_smlr_var,
        at = list(qulty_smlr_var = decomp.high))

rm(decomp.high, decomp.low)
```

###### Pose feeling
```{r}
models[["supplementary"]][["feel.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l.pose)
```

```{r}
anova(models[["supplementary"]][["feel.rating"]])

# decompose trial * quality * condition interaction
## examine when quality is one SD below mean
decomp.low = mean(DF.l.pose$qulty_feel_var,
                  na.rm = T) -
  sd(DF.l.pose$qulty_feel_var,
     na.rm = T)
  
emmeans(models[["supplementary"]][["feel.rating"]],
        pairwise ~ trial | condition | qulty_feel_var,
        at = list(qulty_feel_var = decomp.low))

## when quality is one SD above mean
decomp.high = mean(DF.l.pose$qulty_feel_var,
                  na.rm = T) +
  sd(DF.l.pose$qulty_feel_var,
     na.rm = T)

emmeans(models[["supplementary"]][["feel.rating"]],
        pairwise ~ trial | condition | qulty_feel_var,
        at = list(qulty_feel_var = decomp.high))

rm(decomp.high, decomp.low, DF.l.pose)
```

##### Awareness
```{r}
models[["supplementary"]][["awareness"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  awareness +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["awareness"]])

# decompose trial * quality * condition interaction
## examine when awareness is one SD below mean
decomp.low = mean(DF.l$awareness,
                  na.rm = T) -
  sd(DF.l$awareness,
     na.rm = T)
  
emmeans(models[["supplementary"]][["awareness"]],
        pairwise ~ trial | condition | awareness,
        at = list(awareness = decomp.low))

## when awareness is one SD above mean
decomp.high = mean(DF.l$awareness,
                   na.rm = T) -
  sd(DF.l$awareness,
     na.rm = T)

emmeans(models[["supplementary"]][["awareness"]],
        pairwise ~ trial | condition | awareness,
        at = list(qulty_rate_var = decomp.high))

rm(decomp.high, decomp.low, DF.l.pose)
```

##### Body awareness
indiv_body
```{r}
models[["supplementary"]][["body.aware"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  indiv_body +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)
```

```{r}
anova(models[["supplementary"]][["body.aware"]])
```

## Data viz
Remove participants who exhibited awareness of the hypothesis
```{r}
DF.l.unaware <- DF.l %>% 
  filter(inc.awa == 1)
```

Fix labels
```{r}
DF.l.unaware <- DF.l.unaware %>% 
  mutate(trial = recode(trial,
                        neutr = "neutral",
                        happy = "happy"),
         condition = recode(condition,
                            directd = "directed facial action",
                            mimicry = "facial mimicry",
                            pentask = "pen-in-mouth"),
         image = recode(image,
                        absentt = "stimuli absent",
                        present = "stimuli present")
         )
```

Plotting options
```{r}
theme_set(theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                legend.position = "none"))
```

```{r}
ggplot(DF.l.unaware, 
       aes(x = trial, 
           y = happiness)) +
  facet_grid(rows = vars(image),
             cols = vars(condition)) +
  geom_jitter(width = .1, 
              alpha = .075) + 
  geom_line(alpha = .075, 
            aes(group = ResponseId)) +
  stat_summary(geom = "line",
               colour = "black",
               size = 1,
               aes(group = 1)) +
  stat_summary(fun.data = "mean_cl_boot",
               colour = "black", 
               size = .5) +
  labs(y = "Self-reported happiness", 
       x = "Facial expression pose")
```

