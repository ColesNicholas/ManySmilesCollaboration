---
title: 'Many Smiles Collaboration Data Analysis'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III SS
options(contrasts = c('contr.sum', 'contr.poly'))
```

## Open data
```{r}
DF.l <- readRDS("DF.l.rds")
DF.l.full <- readRDS("DF.l.full.rds")
DF.w <- readRDS("DF.w.rds")
```

## Participant descriptives
```{r}
# condition n
table(DF.w$condition)

table(DF.w$condition, DF.w$image)

# gender
table(DF.w$indiv_gend_var) %>% prop.table()

# age
DF.w %>% 
  summarise(m = mean(indiv_agee_var,
                     na.rm = T),
            sd = sd(indiv_agee_var,
                    na.rm = T))

# lab
table(DF.w$lab)
```

## Analyses
Remove participants who do not meet inclusion criteria
Note: this currently means that you lose almost all data because most labs have not yet completed coding of key inclusion criteria variables
```{r}
DF.l <- DF.l %>% 
  filter(inc == 1)
```

### Primary analysis
Note: random slopes do not converge well (and takes a *very* long time). 
Worth considering whether they should be included in the model?
```{r eval = FALSE}
m <- lmer(happiness ~ 
            trial * condition * image + 
            (1 | lab) +
            (1 | ResponseId) + 
            (0 + condition | lab) +
            (0 + image | lab) +
            (0 + trial : image | lab) +
            (0 + trial : condition | lab) +
            (0 + condition : image | lab) +
            (0 + trial : condition: image | lab),
          data = DF.l)

write_rds(m, "model.rds")
```

Inspect model
```{r}
m <- read_rds("model.rds")

summary(m)
anova(m)

joint_tests(m, by = "condition")

emmeans(c.lmer, pairwise ~ trial | image | condition,
        adjust = "none")

rm(m)
```

### Secondary analyses
#### Pose quality moderation
```{r}
m <- lmer(happiness ~ 
            trial + qulty_rate_var + trial : qulty_rate_var +
            condition + image +
            (1 | lab) + 
            (1 | ResponseId) + 
            (0 + trial | lab) + 
            (0 + image | lab) + 
            (0 + condition | lab) +  
            (0 + trial : qulty_rate_var | lab),
          data = DF.l)
```

### Does awareness vary across conditions? 
```{r}
m <- lmer(awareness ~ 
            condition + image +
            (1 | lab) +
            (0 + condition | lab) +  
            (0 + image | lab),
          data = DF.l
          )
```

### Does awareness moderate facial feedback effects?
```{r}
m <- lmer(happiness ~ 
            trial + awareness + trial : awareness + condition + image +
            (1 | lab) +
            (1 | ResponseId) +
            (0 + trial | lab) + 
            (0 + image | lab) + 
            (0 + condition | lab) +  
            (0 + trial : awareness | lab),
       data = DF.long)
```

### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
```{r}
DF.l.fil <- DF.l.full %>% 
  filter(trial != "neutr") %>% 
  mutate(
    trial.fvh = ifelse(test = trial == "happy",
                       yes = "happy",
                       no = "filler"),
    trial.fvh = factor(trial.fvh)
    )

m <- lmer(happiness ~ 
            trial.fvh + condition + image + trial.fvh : image +
            (1 | lab) +
            (1 | ResponseId)+
            (0 + trial.fvh | lab) + 
            (0 + image | lab) + 
            (0 + condition | lab) +  
            (0 + trial.fvh : image | lab),
       data = DF.long.fil)

anova(fil.lmer)

joint_tests(fil.lmer, by = "condition")

joint_tests(fil.lmer, by = "image")

DF.long.fil %>% 
  group_by(trial.fvh) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))  
```

## Exploratory analyses
### Anxiety
```{r}
#####
anx.lmer <- lmer(nrv ~ trial * image * condition + 
                   (1 | subid),
            data = DF.long)
anova(anx.lmer)

emmeans(anx.lmer, "condition") %>% 
  contrast(method = "pairwise")
```

