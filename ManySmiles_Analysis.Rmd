---
title: 'Data Analysis Code for the Many Smiles Collaboration'
editor_options:
  chunk_output_type: console
---
## Setup R environment
```{r message = FALSE, results = "hide"}
# clear environment
rm(list = ls())

# install (if necessary) and load packages
  # function written by stevenworthington 
  Ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, 'Package'])]
      
      if (length(new.pkg)) 
          install.packages(new.pkg, dependencies = TRUE)
      
      sapply(pkg, require, character.only = TRUE)
  }

  # vector of necessary packages
  packages <- c('tidyverse', 'ggplot2', 'lme4',
                'lmerTest', 'emmeans', 'metafor',
                'ggtext')
  
  # using vector of packages, call ipak function
  Ipak(packages)
  
  # delete vestigial
  rm(packages, Ipak)

# turn scientific notation off
options(scipen = 999)

# allow for Type III Sums of Square
options(contrasts = c('contr.sum', 'contr.poly'))

# set plotting options 
theme_set(theme_classic() +
          theme(strip.background = element_rect(fill = "gray35"),
                strip.text =element_text(colour = "white"),
                panel.border = element_blank(),
                legend.position = "none"
                )
          )
```

## Open data
```{r}
DF.w <- readRDS("data/DF.w.rds")
DF.l.full <- readRDS("data/DF.l.full.rds")
DF.l <- readRDS("data/DF.l.rds")
DF.l.inc <- readRDS("data/DF.l.inc.rds")
```

## Participant descriptives
```{r}
# n participants
DF.w %>% nrow()

# n labs
DF.l$lab %>% unique() %>% length()

# n countries
DF.l$lab %>% 
  substr(start = 1,
         stop = 3) %>% 
  unique() %>% 
  length()

# condition n
table(DF.l$condition) %>% prop.table()
table(DF.l$condition, DF.l$image) %>% prop.table()

# gender
table(DF.l$indiv_gend_var) %>% prop.table()

# age
DF.w %>% 
  summarise(m = mean(indiv_agee_var,
                     na.rm = T),
            sd = sd(indiv_agee_var,
                    na.rm = T))
```

## Analyses
Create list to save models in
```{r}
models <- list()
```

### Primary analyses
#### With application of pre-registered exclusion criteria
Fit model and inspect results
```{r}
# fit model 
models[["primary"]][["prereg.min"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.min"]])

anova(models[["primary"]][["prereg.min"]])

joint_tests(models[["primary"]][["prereg.min"]],
            by = "condition",
            lmerTest.limit = 9999)

joint_tests(models[["primary"]][["prereg.min"]], 
            by = c("image", "condition"),
            lmerTest.limit = 9999)

# descriptives
DF.l.inc %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.inc %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

Simple comparison of facial mimicry and voluntary facial action task
```{r}
lmer(happiness ~ trial * condition * image +
       (1 | ResponseId) +
       (1 | lab),
     data = DF.l.inc,
     subset = condition != "pentask") %>% 
  anova()
```

#### Sensitivity analysis with maximal model
Note: this code is all set to not evaluate because it is computationally intensive

Fit model and inspect results
```{r eval = F}
# fit model
models[["primary"]][["prereg.max"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | ResponseId) +
         (1 + trial * condition * image | lab),
       data = DF.l.inc)

# inspect results
summary(models[["primary"]][["prereg.max"]])

anova(models[["primary"]][["prereg.max"]])

joint_tests(models[["primary"]][["prereg.max"]],
            by = "condition",
            lmerTest.limit = 9999)

joint_tests(models[["primary"]][["prereg.max"]], 
            by = c("image", "condition"),
            lmerTest.limit = 9999)
```

#### Sensitivity analysis with full dataset
Fit model and inspect results
```{r}
# fit model
models[["primary"]][["full.sens"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.l)

# inspect results
summary(models[["primary"]][["full.sens"]])

anova(models[["primary"]][["full.sens"]])

joint_tests(models[["primary"]][["full.sens"]], 
            by = "condition",
            lmerTest.limit = c)

joint_tests(models[["primary"]][["full.sens"]],
            by = "condition",
            lmerTest.limit = full.sens)

joint_tests(models[["primary"]][["full.sens"]], 
            by = c("image", "condition"),
            lmerTest.limit = full.sens)
```

### Secondary analyses
#### Do Participants Report Experiencing More Happiness During the Smiling vs. Filler Trials?
Prepare data by choosing the full dataset (which contains filler trials) and applying inclusion criteria.
```{r}
DF.l.fil <- DF.l.full %>% 
  filter(inc == 1,
         inc.awa == 1)
```

Fit model and inspect results
```{r}
# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial * condition * image +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

# inspect results
anova(models[["secondary"]][["alt.exp"]])

joint_tests(models[["secondary"]][["alt.exp"]], 
            by = "image",
            lmerTest.limit = 9999)

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial | condition | image,
        adjust = "none")
```

##### Sensitivity analysis with maximial model
Note: this code is all set to not evaluate because it is computationally intensive. It also removes the image absent condition because (a) it helps the model converge in a reasonably quick amount of time and (b) this condition is not relevant for the inferences (see manuscript for more information).  
```{r eval = F}
# prepare data
DF.l.fil <- DF.l.full %>% 
  filter(inc == 1,
         inc.awa == 1,
         image == "absentt")

# fit model
models[["secondary"]][["alt.exp"]] <-
  lmer(happiness ~ trial * condition +
         (1 + trial * condition | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

# inspect results
anova(models[["secondary"]][["alt.exp"]])

emmeans(models[["secondary"]][["alt.exp"]], 
        pairwise ~ trial | condition,
        adjust = "none")
```

#### Liking reports
Fit model and inspect results
```{r}
# fit model
models[["secondary"]][["liking"]] <-
  lmer(tsk ~ trial * condition +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.fil)

# inspect results
anova(models[["secondary"]][["liking"]])

joint_tests(models[["secondary"]][["liking"]], 
            by = "condition",
            lmerTest.limit = 3008)

emmeans(models[["secondary"]][["liking"]], 
        pairwise ~ trial | condition,
        adjust = "none")

# descriptives
DF.l.fil %>% 
  group_by(condition, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))

DF.l.fil %>% 
  group_by(condition, image, trial) %>% 
  summarise(m = mean(happiness),
            sd = sd(happiness))
```

#### Effect of facial feedback on anxiety and anger
Anxiety: fit model and inspect results
```{r}
# fit model
models[["secondary"]][["anxiety"]] <-
  lmer(anxiety ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["anxiety"]])
```

Anger: fit model and inspect results
```{r}
# fit model
models[["secondary"]][["anger"]] <-
  lmer(anger ~ trial * image * condition + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["anger"]])
```

Descriptives
```{r}
DF.l %>% 
  group_by(condition) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))

DF.l %>% 
  group_by(trial) %>% 
  summarise(m.anx = mean(anxiety),
            sd.anx = sd(anxiety),
            m.ang = mean(anger),
            sd.ang = sd(anger))
```

#### Moderator analyses
##### Quality
###### Adherence to instructions
```{r}
# fit model
models[["secondary"]][["quality.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["quality.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
lmer(happiness ~ 
         trial * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_rate_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()
```

Examine how much adherence is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_rate_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# five is where there is a switch (except for pen, which requires a 6)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_rate_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

###### Pose similarity
```{r}
# fit model
models[["secondary"]][["simil.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["simil.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
lmer(happiness ~ 
         trial * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_smlr_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()
```

Examine how much similarity is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_smlr_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# 2 is where there is a switch (for all besides mimicry, which requires a 3)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_smlr_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

###### Genuineness ratings
```{r}
# fit model
models[["secondary"]][["feel.rating"]] <-
  lmer(happiness ~ 
         trial * condition * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["feel.rating"]])
```

Look at facial feedback task-specific moderating effects
```{r}
lmer(happiness ~ 
         trial * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "mimicry") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "directd") %>% 
  anova()

lmer(happiness ~ 
         trial * image * qulty_feel_var.c +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l,
     subset = condition == "pentask") %>% 
  anova()
```

Examine how much genuineness is required for a significant facial feedback effect
```{r}
# fit simpler model without centered variable for ease of interpretation
tmp <- lmer(happiness ~ 
              trial * condition * qulty_feel_var +
         (1 | lab) + 
         (1 | ResponseId),
       data = DF.l)

# 2 is when it switches over (for all conditions)
lapply(X = c(1 : 7), 
       function(x){
         emmeans(tmp,
                 pairwise ~ trial | condition,
                 at = list(qulty_feel_var = x))
         }
       )

# delete vestigial
rm(tmp)
```

##### Awareness
```{r}
# fit model
models[["secondary"]][["awareness"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  awareness +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["awareness"]])
```

##### Body awareness
```{r}
# fit model
models[["secondary"]][["body.aware"]] <- 
  lmer(happiness ~ 
         trial * condition * image *  indiv_body +
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l)

# inspect results
anova(models[["secondary"]][["body.aware"]])
```

### Exploratory Analyses
#### Primary analyses excluding anxious participants
Fiilter data, fit model, inspect results
```{r}
# filter data
DF.inc.no.anx <- DF.l.inc %>% 
  filter(anxiety == 1)

# sample size
DF.inc.no.anx$ResponseId %>% unique %>% length()

# fit model
models[["exploratory"]][["no.anx"]] <- 
  lmer(happiness ~ trial * image * condition +
         (1 | ResponseId) +
         (1 | lab),
       data = DF.inc.no.anx)

# inspect results
anova(models[["exploratory"]][["no.anx"]])

joint_tests(models[["exploratory"]][["no.anx"]],
            by = "condition",
            lmerTest.limit = 9999)

# delete vistigial 
rm(DF.inc.no.anx)
```

## Data viz
### Figure 3
Fix labels
```{r}
DF.viz <- 
  DF.l.full %>%
  filter(inc == 1,
         inc.awa == 1) %>% 
  mutate(trial = factor(trial,
                        levels = c("happy",
                                   "neutr",
                                   "fil.1",
                                   "fil.4")),
         trial = recode(trial,
                        fil.1 = "filler 1",
                        happy = "happy",
                        neutr = "neutral",
                        fil.4 = "filler 2"),
         condition = factor(condition,
                            levels = c("mimicry",
                                       "directd",
                                       "pentask")),
         condition = recode(condition,
                            directd = "voluntary facial action",
                            mimicry = "facial mimicry",
                            pentask = "pen-in-mouth"),
         image = recode(image,
                        absentt = "positive stimuli absent",
                        present = "positive stimuli present")
         )
```

```{r}
tmp <- DF.viz %>% 
  group_by(trial, condition, image) %>% 
  summarise(m = round(mean(happiness),
                      2),
            sd = round(sd(happiness),
                       2))

tmp2 <- DF.viz %>% 
  group_by(condition, image) %>%
  summarise(n = length(unique(ResponseId)))

tmp3 <- full_join(tmp, tmp2)
  
png(filename = "figures/Figure3.png", 
       units = "in", 
       width = 7, 
       height = 6.5, 
       res = 300)

ggplot(DF.viz, 
       aes(x = trial, 
           y = happiness)) +
  # split plot by image and condition
  facet_grid(rows = vars(image),
             cols = vars(condition)) +
  
  # add jittered raw data
  geom_jitter(width = .1, 
              alpha = .07,
              colour = "dark grey") + 
  
  # connect participants' jittered raw data
  geom_line(alpha = .07, 
            aes(group = ResponseId),
            colour = "dark grey") +
  
  # add summary lines
  stat_summary(geom = "line",
               colour = "#3366FF",
               size = 1,
               aes(group = 1)) +
  
  stat_summary(colour = "#3366FF", 
               size = .5,
               fun = "mean") +
  
  # add task-specific M's and SDs
  geom_text(data = tmp3,
            aes(label = paste0("M = ", m,
                               "\n",
                               "SD = ", sd)),
            y = Inf,
            size = 2,
            vjust = 2) +
  
  # add condition-specific ns
  geom_text(data = tmp3,
            aes(label = paste0("n = ", n)),
            x = 2.5,
            y = Inf,
            size = 2,
            vjust = 2) +
  
  # adjust scales
  scale_x_discrete(
    expand = expand_scale(mult = c(.2, .2))) +
  
  scale_y_continuous(
    breaks = c(1, 3, 5, 7),
    expand = expand_scale(mult = c(0, .25))) +
  
  labs(y = "Self-reported happiness", 
     x = "Task")

dev.off()
```

### Figure 3b?
```{r}
DF.viz2 <- DF.viz %>% 
  # filter
  filter(trial == "happy" |
           trial == "neutral") %>% 
  select(ResponseId, condition, image, trial, happiness) %>% 
  pivot_wider(names_from = "trial",
              values_from = "happiness") %>% 
  rowwise() %>% 
  mutate(happiness.avg = mean(c(happy, neutral))) %>% 
  ungroup()

tmp <- DF.viz2 %>% 
  group_by(image, condition) %>% 
  summarise(n = n(),
            m = round(mean(happiness.avg),
                      2),
            sd = round(sd(happiness.avg),
                       2))

png(
  filename = "figures/Figure3b.png",
  units = "in",
  width = 7,
  height = 6.5,
  res = 300
)

ggplot(DF.viz2, 
       aes(x = image, 
           y = happiness.avg)) +
  facet_grid(cols = vars(condition)) +
  geom_jitter(width = .1, 
              alpha = .07,
              colour = "dark grey") +
  geom_boxplot(colour = 'dark grey',
               fill = NA,
               outlier.shape = NA) +
  stat_summary(colour = "#3366FF", 
               size = .5,
               fun = "mean") +
  labs(y = "Self-reported happiness", 
       x = "Stimuli Presence") +
  
  # add task-specific M's, SDs,
  geom_text(data = tmp,
            aes(label = paste0("n = ", n,
                               "\n", 
                               "M = ", m,
                               "\n",
                               "SD = ", sd)),
            y = 7.3,
            size = 2) +
  scale_y_continuous(
    breaks = c(1, 3, 5, 7)) +
  # adjust scales
  scale_y_continuous(
    breaks = c(1, 3, 5, 7),
    expand = expand_scale(mult = c(0, .1))) +
  
  scale_x_discrete(labels = c("absent", "present"))

dev.off()
```

### Figure 4
Create dataset for the data viz
```{r}
DF.viz <- DF.l %>% 
  # select relevant variables
  select(ResponseId, trial, condition, 
         happiness, 
         awareness, qulty_rate_var, 
         qulty_feel_var, qulty_smlr_var, 
         indiv_body) %>% 
  
  # calculate a difference score between the happy and neutral poses
  pivot_wider(names_from = trial,
              values_from = happiness) %>%
  rowwise() %>% 
  mutate(happ.diff = happy - neutr) %>% 
  ungroup() %>% 
  
  # pivot longer so that there is one row for each moderator
  pivot_longer(cols = c(qulty_rate_var, 
                        qulty_smlr_var,
                        qulty_feel_var,
                        awareness,
                        indiv_body),
               names_to = "mod") %>% 
  filter(mod == "qulty_rate_var" |
         mod == "qulty_smlr_var" |
         mod == "qulty_feel_var") %>% 
  
  # relevel factors 
  mutate(condition = factor(condition,
                            levels = c("mimicry",
                                       "directd",
                                       "pentask")),
         condition = recode(condition,
                            directd = "voluntary facial action",
                            mimicry = "facial mimicry",
                            pentask = "pen-in-mouth"),
         mod = factor(mod,
                      levels = c("qulty_rate_var",
                                 "qulty_feel_var",
                                 "qulty_smlr_var")),
         mod = recode(mod,
                      qulty_rate_var = "compliance",
                      qulty_feel_var = "genuineness",
                      qulty_smlr_var = "similarity",))
```

```{r}
DF.viz$sig.cross = as.numeric(NA)
DF.viz$mode = as.numeric(NA)

# compliance
DF.viz[DF.viz$condition == "facial mimicry" & 
       DF.viz$mod == "compliance", ]$sig.cross <- 5
DF.viz[DF.viz$condition == "facial mimicry" & 
       DF.viz$mod == "compliance", ]$mode <- 7

DF.viz[DF.viz$condition == "voluntary facial action" & 
       DF.viz$mod == "compliance", ]$sig.cross <- 5
DF.viz[DF.viz$condition == "voluntary facial action" & 
       DF.viz$mod == "compliance", ]$mode <- 7

DF.viz[DF.viz$condition == "pen-in-mouth" & 
       DF.viz$mod == "compliance", ]$sig.cross <- 6
DF.viz[DF.viz$condition == "pen-in-mouth" & 
       DF.viz$mod == "compliance", ]$mode <- 7

# similarity
DF.viz[DF.viz$condition == "facial mimicry" & 
       DF.viz$mod == "similarity", ]$sig.cross <- 3
DF.viz[DF.viz$condition == "facial mimicry" & 
       DF.viz$mod == "similarity", ]$mode <- 6

DF.viz[DF.viz$condition == "voluntary facial action" & 
       DF.viz$mod == "similarity", ]$sig.cross <- 2
DF.viz[DF.viz$condition == "voluntary facial action" & 
       DF.viz$mod == "similarity", ]$mode <- 7

DF.viz[DF.viz$condition == "pen-in-mouth" & 
       DF.viz$mod == "similarity", ]$sig.cross <- 2
DF.viz[DF.viz$condition == "pen-in-mouth" & 
       DF.viz$mod == "similarity", ]$mode <- 6

# genuineness 
DF.viz[DF.viz$mod == "genuineness", ]$sig.cross <- 2

DF.viz[DF.viz$condition == "facial mimicry" & 
       DF.viz$mod == "genuineness", ]$mode <- 5
DF.viz[DF.viz$condition == "voluntary facial action" & 
       DF.viz$mod == "genuineness", ]$mode <- 5
DF.viz[DF.viz$condition == "pen-in-mouth" & 
       DF.viz$mod == "genuineness", ]$mode <- 1
```

```{r}
png(filename = "figures/Figure4.png", 
       units = "in", 
       height = 7, 
       width = 6.5, 
       res = 300)

ggplot(DF.viz, 
       aes(x = value, 
           y = happ.diff)) +
  facet_grid(cols = vars(condition),
             rows = vars(mod)) +
  geom_rect(aes(xmin = sig.cross - .25,
                xmax = 7.25,
                ymin = -6,
                ymax = 6),
            fill = "lightgreen",
            alpha = .01) +
  geom_rect(aes(xmin = mode - .25,
                xmax = mode + .25,
                ymin = -6,
                ymax = 6),
            fill = NA,
            colour = "black") + 
  geom_jitter(width = .1, 
              alpha = .2,
              colour = "dark grey") +
  geom_smooth(method = 'lm') +
  xlab("Self-reported rating") +
  ylab("Change in self-reported happiness") + 
  scale_x_continuous(
    breaks = c(1, 3, 5, 7))

dev.off()
```

### Figure 2
```{r}
tmp <- DF.viz %>% 
  group_by(condition, mod) %>% 
  summarise(m = round(mean(value,
                           na.rm = T),
                      2),
            sd = round(sd(value, na.rm = T),
                       2)
            )

tmp2 <- DF.viz %>% 
  filter(!is.na(value)) %>% 
  group_by(condition, mod) %>% 
  tally()

tmp3 <- full_join(tmp, tmp2)

rm(tmp, tmp2)

png(filename = "figures/Figure2.png", 
       units = "in", 
       width = 7, 
       height = 6.5, 
       res = 300)


ggplot(DF.viz,
       aes(x = value)) +
  
  # split plot by condition and moderator
  facet_grid(cols = vars(condition),
             rows = vars(mod),
             scales = "free_y") +
  
  # plot histogram (as percentage)
  geom_histogram(aes(y = stat(width*density)),
                 bins = 7,
                 fill = "gray60") +
  
  # add bin-specific percentage counts to histogram
  stat_bin(aes(y = stat(width*density),
               label = 
                 paste0((round(stat(width*density),
                               2) * 100),
                        "%")), 
           geom = "text",
           bins = 7,
           size = 2,
           vjust = -.21) +
  
  # paste descriptive statistics to left of histogram
  geom_text(data = tmp3,
            aes(label = paste0("n = ", n,
                               "\n",
                               "M = ", m,
                               "\n",
                               "SD = ", sd)),
            x = -1.25,
            y = Inf,
            size = 2,
            hjust = 0,
            vjust = 1.25) +
  
  # fix scales
  scale_x_continuous(name = "Self-reported rating",
                     breaks = c(1, 3, 5, 7),
                     expand = expand_scale(mult = c(.30, .01))) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .14)),
                     name = "Percent",
                     labels = scales::percent_format())

dev.off()
```

### Figure2b
```{r}
DF.viz <- DF.l.inc %>% 
  # select relevant variables
  select(ResponseId, trial, condition, 
         happiness, 
         awareness, qulty_rate_var, 
         qulty_feel_var, qulty_smlr_var, 
         indiv_body) %>% 
  
  # calculate a difference score between the happy and neutral poses
  pivot_wider(names_from = trial,
              values_from = happiness) %>%
  rowwise() %>% 
  mutate(happ.diff = happy - neutr) %>% 
  ungroup() %>% 
  
  # pivot longer so that there is one row for each moderator
  pivot_longer(cols = c(qulty_rate_var, 
                        qulty_smlr_var,
                        qulty_feel_var,
                        awareness,
                        indiv_body),
               names_to = "mod") %>% 
  filter(mod == "qulty_rate_var" |
         mod == "qulty_smlr_var" |
         mod == "qulty_feel_var") %>% 
  
  # relevel factors 
  mutate(condition = factor(condition,
                            levels = c("mimicry",
                                       "directd",
                                       "pentask")),
         condition = recode(condition,
                            directd = "voluntary facial action",
                            mimicry = "facial mimicry",
                            pentask = "pen-in-mouth"),
         mod = factor(mod,
                      levels = c("qulty_rate_var",
                                 "qulty_feel_var",
                                 "qulty_smlr_var")),
         mod = recode(mod,
                      qulty_rate_var = "compliance",
                      qulty_feel_var = "genuineness",
                      qulty_smlr_var = "similarity",))
```

```{r}
tmp <- DF.viz %>% 
  group_by(condition, mod) %>% 
  summarise(m = round(mean(value,
                           na.rm = T),
                      2),
            sd = round(sd(value, na.rm = T),
                       2)
            )

tmp2 <- DF.viz %>% 
  filter(!is.na(value)) %>% 
  group_by(condition, mod) %>% 
  tally()

tmp3 <- full_join(tmp, tmp2)

rm(tmp, tmp2)

png(filename = "figures/Figure2b.png", 
       units = "in", 
       width = 7, 
       height = 6.5, 
       res = 300)

ggplot(DF.viz,
       aes(x = value)) +
  
  # split plot by condition and moderator
  facet_grid(cols = vars(condition),
             rows = vars(mod),
             scales = "free_y") +
  
  # plot histogram (as percentage)
  geom_histogram(aes(y = stat(width*density)),
                 bins = 7,
                 fill = "gray60") +
  
  # add bin-specific percentage counts to histogram
  stat_bin(aes(y = stat(width*density),
               label = 
                 paste0((round(stat(width*density),
                               2) * 100),
                        "%")), 
           geom = "text",
           bins = 7,
           size = 2,
           vjust = -.21) +
  
  # paste descriptive statistics to left of histogram
  geom_text(data = tmp3,
            aes(label = paste0("n = ", n,
                               "\n",
                               "M = ", m,
                               "\n",
                               "SD = ", sd)),
            x = -1.25,
            y = Inf,
            size = 2,
            hjust = 0,
            vjust = 1.25) +
  
  # fix scales
  scale_x_continuous(name = "Self-reported rating",
                     breaks = c(1, 3, 5, 7),
                     expand = expand_scale(mult = c(.30, .01))) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .14)),
                     name = "Percent",
                     labels = scales::percent_format())

dev.off()
```

### Figure 5
Calculate country-specific effect sizes for facial feedback tasks
```{r}
pose.es.DF <- DF.l.inc %>%
  # pivot data wider
  pivot_wider(names_from = trial,
              values_from = happiness,
              id_cols = c(ResponseId,
                          country,
                          lab,
                          UserLanguage,
                          condition)) %>% 
  
  # calculate difference score
  rowwise() %>% 
  mutate(diff = happy - neutr) %>% 
  
  # for each condition and country, find correlation between two trials and the mean/sd of the difference score
  group_by(condition, country) %>% 
  summarise(n = n(),
            corr = cor(happy, neutr),
            m.diff = mean(diff),
            sd.diff = sd(diff)) %>% 
  ungroup() %>% 
  
  # calculate cohen drm
  # formula: Cooper, Hedges, & Valentine, 2009; p. 229
  rowwise() %>% 
  mutate(d = (m.diff / sd.diff) * 
           sqrt(2 * (1 - corr))) %>% 
  
  # calculate variance of d
  mutate(d.var = ((1 / n) + ((d^2) / (2 * n))) * 
           2 * (1 - corr)) %>% 
  
  # calculate CI of d
  mutate(lb = d - (1.96 * sqrt(d.var)),
         ub = d + (1.96 * sqrt(d.var))) %>% 
  
  # select relevant variables
  select(condition, country, d, d.var, lb, ub)
```

Calculate country-specific effect sizes for image
```{r}
img.es.DF <- DF.l.inc %>% 
  # pivot data wide
  pivot_wider(names_from = trial,
              values_from = happiness,
              id_cols = c(ResponseId,
                          country,
                          image,
                          lab,
                          UserLanguage,
                          condition)) %>% 
  
  # remove pen-in-mouth
  filter(condition != "pentask") %>% 
  
  # calculate happiness mean and sd when images were present vs. absent in each country
  group_by(country, image) %>% 
  summarise(n = n(),
            m = mean(neutr),
            sd = sd(neutr)) %>%
  ungroup() %>% 
  
  # pivot data wider
  pivot_wider(names_from = image,
              values_from = c(n, m, sd)) %>% 
  
  # calculate cohen's drm
  # formula: Cooper, Hedges, & Valentine, 2009; p. 226
  rowwise() %>% 
  mutate(sd.pooled = sqrt((((n_absentt - 1) * (sd_absentt^2)) +
                             ((n_present - 1) * (sd_present^2))) /
                            (n_absentt + n_present - 2))) %>% 
  mutate(d = (m_present - m_absentt) / sd.pooled) %>% 

  # calculate variance of cohen's d
  mutate(d.var = ((n_absentt + n_present) / (n_absentt * n_present)) +
           ((d^2) / (2 * (n_absentt + n_present)))) %>% 
  
  # calculate CI of d
  mutate(lb = d - (1.96 * sqrt(d.var)),
         ub = d + (1.96 * sqrt(d.var))) %>% 
  
  # match formatting with meta.DF
  mutate(condition = "image") %>% 
  select(condition, country, d, d.var, lb, ub)
```

Merge facial feedback and image effect size databases
```{r}
meta.DF <- rbind(pose.es.DF, img.es.DF) %>% 
  as.data.frame()

rm(pose.es.DF, img.es.DF)
```

Fit random effects meta-analyses
```{r}
# see if effect is moderated by task
rma(
  yi = d,
  vi = d.var,
  slab = country,
  data = meta.DF,
  subset = condition != "image"
)

rma(
  yi = d,
  vi = d.var,
  mods = condition,
  slab = country,
  data = meta.DF,
  subset = condition != "image"
)

meta.m  <- rma(
  yi = d,
  vi = d.var,
  slab = country,
  data = meta.DF,
  subset = condition == "mimicry")

meta.d <- rma(
  yi = d,
  vi = d.var,
  slab = country,
  data = meta.DF,
  subset = condition == "directd"
)

meta.p <- rma(
  yi = d,
  vi = d.var,
  slab = country,
  data = meta.DF,
  subset = condition == "pentask"
)

meta.i <- rma(
  yi = d,
  vi = d.var,
  slab = country,
  data = meta.DF,
  subset = condition == "image"
)
```

Add meta-analytic results to dataframe
```{r}
meta.DF <- meta.DF %>% 
  mutate(Q = NA,
         Q.p = NA,
         i2 = NA,
         t2 = NA)

meta.DF <- rbind(
  meta.DF,
  
  # mimicry
  cbind(
    condition = "mimicry",
    country = "Overall",
    d = meta.m[["beta"]] %>%
      as.numeric(),
    d.var = meta.m[["se"]] ^ 2,
    lb = meta.m[["ci.lb"]],
    ub = meta.m[["ci.ub"]],
    Q = round(meta.m$QE, 2),
    Q.p = round(meta.m$QEp, 3),
    i2 = round(meta.m$I2, 0),
    t2 = round(meta.m$tau2, 2)
  ),
  
  # directd
  cbind(
    condition = "directd",
    country = "Overall",
    d = meta.d[["beta"]] %>%
      as.numeric(),
    d.var = meta.d[["se"]] ^ 2,
    lb = meta.d[["ci.lb"]],
    ub = meta.d[["ci.ub"]],
    Q = round(meta.d$QE, 2),
    Q.p = round(meta.d$QEp, 3),
    i2 = round(meta.d$I2, 0),
    t2 = round(meta.d$tau2, 2)
  ),
  
  # pentask
  cbind(
    condition = "pentask",
    country = "Overall",
    d = meta.p[["beta"]] %>%
      as.numeric(),
    d.var = meta.p[["se"]] ^ 2,
    lb = meta.p[["ci.lb"]],
    ub = meta.p[["ci.ub"]],
    Q = round(meta.p$QE, 2),
    Q.p = round(meta.p$QEp, 3),
    i2 = round(meta.p$I2, 0),
    t2 = round(meta.p$tau2, 2)
  ),
  
  # image
  cbind(
    condition = "image",
    country = "Overall",
    d = meta.i[["beta"]] %>%
      as.numeric(),
    d.var = meta.i[["se"]] ^ 2,
    lb = meta.i[["ci.lb"]],
    ub = meta.i[["ci.ub"]],
    Q = round(meta.i$QE, 2),
    Q.p = round(meta.i$QEp, 3),
    i2 = round(meta.i$I2, 0),
    t2 = round(meta.i$tau2, 2)
  )
) %>% as.data.frame()

rm(meta.d, meta.m, meta.p, meta.i)
```

Format dataset
```{r}
meta.DF <- meta.DF %>% 
  mutate(
    # identify which effects are overall vs. country-specific
    overall = if_else(condition = country == "Overall",
                      true = 1, 
                      false = 0),
    
    # order effect sizes by whether they are (a) overall vs. country-specific and then (b) size of the effect
    country = fct_reorder(country,
                          desc(d)),
    country = fct_reorder(country,
                          desc(overall)),
    
    # fix format of numeric variables
    d = as.numeric(d),
    lb = as.numeric(lb),
    ub = as.numeric(ub),
    
    # relevel and recode condition variable
    condition = factor(condition,
                       levels = c("mimicry",
                                  "directd",
                                  "pentask",
                                  "image")),
    condition = recode(condition,
                       directd = "voluntary facial action",
                       mimicry = "facial mimicry",
                       pentask = "pen-in-mouth",
                       image = "exposure to positive images"))
```

Create forest plot
```{r}
 png(filename = "figures/Figure5.png", 
     units = "in", 
     width = 9, 
     height = 5.07, 
     res = 300)

ggplot(data = meta.DF, 
       aes(x = country, 
           y = d,
           ymin = lb,
           ymax = ub)) +
  geom_rect(aes(fill = condition),
            xmin = -Inf, xmax = Inf,
            ymin = -Inf, ymax = Inf,
            alpha = 0.3) +
  geom_hline(yintercept = 0, 
             color = "black", 
             linetype = "dashed", 
             alpha = .5) +
  geom_point(aes(shape = as.factor(overall),
                 size = as.factor(overall),
                 colour = as.factor(overall))) +
  geom_errorbar(width = .5,
                aes(colour = as.factor(overall))) +
  scale_shape_manual(values = c(15, 18)) +
  scale_size_manual(values = c(2, 4)) +
  scale_color_manual(values= c("dark grey", 
                               "#3366FF")) +
  scale_fill_manual(values = c("white",
                               "white",
                               "white",
                               "ivory2")) +
  coord_flip() +
  facet_grid(cols = vars(condition)) +
  labs(y = expression(paste("Cohen's ", 
                            italic("d"))
                      ),
       x = "Country") +
  ylim(-1.5, 3) +
  geom_richtext(data = meta.DF[meta.DF$overall == 1, ],
            aes(label = paste0("overall <i>d</i> = ", round(d, 2),
                               " [", round(lb, 2), ", ",
                               round(ub, 2), "]",
                               "<br>",
                               " Q = ", Q, ", 
                               <i>p</i> =", round(as.numeric(Q.p), 2),
                               "<br>",
                               " <i>I<sup>2</sup></i> = ", i2, "%", 
                               ", <i>T<sup>2</sup></i> = ", t2),
                x = 1.18,
                y = .8),
            size = 1.8,
            label.colour = NA,
            fill = NA,
            hjust = 0)

dev.off()
```

# TMP
```{r}
tmp <- DF.viz %>% 
  select(ResponseId, condition, trial, anxiety, anger) %>% 
  pivot_longer(cols = c(anxiety, anger))

ggplot(tmp, 
       aes(x = trial, 
           y = value)) +
  # split plot by image and condition
  facet_grid(rows = vars(name),
             cols = vars(condition)) +
  
  # add jittered raw data
  geom_jitter(width = .1, 
              alpha = .07,
              colour = "dark grey") + 
  
  # connect participants' jittered raw data
  geom_line(alpha = .07, 
            aes(group = ResponseId),
            colour = "dark grey") +
  
  # add summary lines
  stat_summary(geom = "line",
               colour = "#3366FF",
               size = 1,
               aes(group = 1)) +
  
  stat_summary(colour = "#3366FF", 
               size = .5,
               fun = "mean")

ggplot(DF.viz, 
       aes(x = trial, 
           y = anxiety)) +
  # split plot by image and condition
  facet_grid(cols = vars(condition)) +
  
  # add jittered raw data
  geom_jitter(width = .1, 
              alpha = .07,
              colour = "dark grey") + 
  
  # connect participants' jittered raw data
  geom_line(alpha = .07, 
            aes(group = ResponseId),
            colour = "dark grey") +
  
  # add summary lines
  stat_summary(geom = "line",
               colour = "#3366FF",
               size = 1,
               aes(group = 1)) +
  
  stat_summary(colour = "#3366FF", 
               size = .5,
               fun = "mean")


```


# TMP
```{r}
control.anx <-
  lmer(happiness ~ anxiety + trial * image + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.inc,
       subset = condition == "pentask")

anova(control.anx)

control.anx <-
  lmer(happiness ~ trial * image + 
         (1 | lab) +
         (1 | ResponseId),
       data = DF.l.inc,
       subset = condition == "pentask" & anxiety == 1)

anova(control.anx)
joint_tests(control.anx, 
            by = "image",
            lmerTest.limit = 10000)



# add ANOVA table
tmp <- anova(models[["primary"]][["partial"]]) %>% 
  rownames_to_column(var = "Omnibus test") %>% 
  mutate(`Pr(>F)` = stars.pval(`Pr(>F)`),
         Decomposition = NA,
         Result = paste0("F(", NumDF, ", ", 
                         round(DenDF, 0), ") = ",
                         round(`F value`, 2),
                         `Pr(>F)`)
         ) %>%
  select(`Omnibus test`,
         Decomposition,
         Result)

# add pose pairwise
pose.pair <- emmeans(models[["primary"]][["partial"]], 
        pairwise ~ trial,
        adjust = "none",
        infer = c(TRUE, TRUE),
        lmerTest.limit = 10000)$contrasts %>%
  as.data.frame() %>% 
  mutate(`Omnibus test` = "trial",
         Decomposition = contrast,
         p.value = stars.pval(p.value),
         Result = paste0("t(", 
                         round(df, 2),
                         ") = ",
                         round(t.ratio, 2),
                         p.value,
                         ", M_diff 95% CI [",
                         round(lower.CL, 2), ", ",
                         round(upper.CL, 2), "]")) %>% 
  select(`Omnibus test`, Decomposition, Result)

tmp <- rbind(tmp, pose.pair)
rm(pose.pair)

# add condition pairwise
cond.pair <- emmeans(models[["primary"]][["partial"]], 
        pairwise ~ condition,
        adjust = "none",
        infer = c(TRUE, TRUE),
        lmerTest.limit = 10000)$contrasts %>%
  as.data.frame() %>% 
  mutate(`Omnibus test` = "condition",
         Decomposition = contrast,
         p.value = stars.pval(p.value),
         Result = paste0("t(", 
                         round(df, 2),
                         ") = ",
                         round(t.ratio, 2),
                         p.value,
                         ", M_diff 95% CI [",
                         round(lower.CL, 2), ", ",
                         round(upper.CL, 2), "]")) %>% 
  select(`Omnibus test`, Decomposition, Result)

tmp <- rbind(tmp, cond.pair)
rm(cond.pair)

# add image pairwise
imag.pair <- emmeans(models[["primary"]][["partial"]], 
        pairwise ~ image,
        adjust = "none",
        infer = c(TRUE, TRUE),
        lmerTest.limit = 10000)$contrasts %>%
  as.data.frame() %>% 
  mutate(`Omnibus test` = "image",
         Decomposition = contrast,
         p.value = stars.pval(p.value),
         Result = paste0("t(", 
                         round(df, 2),
                         ") = ",
                         round(t.ratio, 2),
                         p.value,
                         ", M_diff 95% CI [",
                         round(lower.CL, 2), ", ",
                         round(upper.CL, 2), "]")) %>% 
  select(`Omnibus test`, Decomposition, Result)

tmp <- rbind(tmp, imag.pair)
rm(imag.pair)

# trial * condition
t.c.joint <- 
  joint_tests(models[["primary"]][["partial"]], 
              by = "condition",
              lmerTest.limit = 10000) %>% 
  as.data.frame() %>% 
  filter(`model term` == "trial") %>% 
  mutate(`Omnibus test` = "trial:condition",
         Decomposition = condition,
         Result = paste0("F( ", df1, ", ",
                         round(df2, 2), ") = ",
                         round(F.ratio, 2),
                         stars.pval(p.value))) %>%
  select(`Omnibus test`, Decomposition, Result)

tmp <- rbind(tmp, t.c.joint)
rm(t.c.joint)

# condition * image
c.i.joint <- 
  joint_tests(models[["primary"]][["partial"]], 
              by = "image",
              lmerTest.limit = 10000) %>% 
  as.data.frame() %>% 
  filter(`model term` == "trial") %>% 
  mutate(`Omnibus test` = "condition:image",
         Decomposition = condition,
         Result = paste0("F( ", df1, ", ",
                         round(df2, 2), ") = ",
                         round(F.ratio, 2),
                         stars.pval(p.value))) %>%
  select(`Omnibus test`, Decomposition, Result)

tmp <- rbind(tmp, t.c.joint)
rm(t.c.joint)

emmeans(models[["primary"]][["full"]], 
        pairwise ~ trial | image | condition,
        adjust = "none")
```


```{r}
tmp <- lmer(happiness ~ trial * image 
     + (1 |ResponseId) +
       (1 | lab),
     data = DF.l.inc,
     subset = condition == "pentask")

summary(tmp)
anova(tmp)

# 606 to 351
tmp1 <-
  DF.l.inc %>% 
  filter(condition == "pentask") %>% 
  filter(anxiety == 1)

tmp1 %>% 
  group_by(trial, image) %>%
  count()

tmp2 <- lmer(happiness ~ trial * image + 
             + (1 |ResponseId) +
               (1 | lab),
             data = tmp1)
summary(tmp2)

emmeans(tmp2, 
        pairwise ~ trial | image,
        adjust = "none")

```

